{% extends "organizations/base.html" %}
{% load i18n %}
{% block org_title %}CRM Reports - {{ organization.name }}{% endblock %}
{% block org_content %}
    <!-- Breadcrumbs -->
    <nav class="flex mb-4" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{% url 'organization_detail' organization.pk %}"
                   class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
                    <i class="fas fa-building mr-2"></i>
                    {{ organization.name }}
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <a href="{% url 'crm_dashboard' organization.pk %}"
                       class="text-sm font-medium text-gray-700 hover:text-blue-600">CRM Dashboard</a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <span class="text-sm font-medium text-gray-500">Reports</span>
                </div>
            </li>
        </ol>
    </nav>
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">CRM Reports & Analytics</h1>
                <p class="text-gray-600">Performance insights and business metrics</p>
            </div>
            <div class="flex space-x-2">
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-download mr-2"></i>Export Data
                </button>
            </div>
        </div>
    </div>
    <!-- Date Range Filter -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Report Period</h3>
        <form method="get" class="flex items-center space-x-4">
            <div>
                <label for="date_from" class="block text-sm font-medium text-gray-700 mb-1">From</label>
                <input type="date"
                       id="date_from"
                       name="date_from"
                       value="{{ date_from|date:'Y-m-d' }}"
                       class="border border-gray-300 rounded-lg px-3 py-2">
            </div>
            <div>
                <label for="date_to" class="block text-sm font-medium text-gray-700 mb-1">To</label>
                <input type="date"
                       id="date_to"
                       name="date_to"
                       value="{{ date_to|date:'Y-m-d' }}"
                       class="border border-gray-300 rounded-lg px-3 py-2">
            </div>
            <div class="pt-6">
                <button type="submit"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                    Update Report
                </button>
            </div>
        </form>
    </div>
    <!-- Sales Metrics -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-chart-line mr-2 text-green-600"></i>Sales Performance
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="text-center">
                <div class="text-3xl font-bold text-green-600">${{ sales_metrics.total_value|floatformat:0 }}</div>
                <div class="text-sm text-gray-600">Total Revenue</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-blue-600">{{ sales_metrics.total_deals }}</div>
                <div class="text-sm text-gray-600">Total Deals</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-purple-600">{{ sales_metrics.win_rate|floatformat:1 }}%</div>
                <div class="text-sm text-gray-600">Win Rate</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-orange-600">${{ sales_metrics.avg_deal_size|floatformat:0 }}</div>
                <div class="text-sm text-gray-600">Avg Deal Size</div>
            </div>
        </div>
        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h4 class="font-medium text-gray-900 mb-2">Deal Status Breakdown</h4>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-green-600">Won: {{ sales_metrics.won_deals }}</span>
                        <span class="text-red-600">Lost: {{ sales_metrics.lost_deals }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Contact Metrics -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-users mr-2 text-blue-600"></i>Contact Analytics
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h4 class="font-medium text-gray-900 mb-3">New Contacts: {{ contact_metrics.new_contacts }}</h4>
                {% if contact_metrics.by_source %}
                    <div class="space-y-2">
                        <h5 class="text-sm font-medium text-gray-700">By Lead Source:</h5>
                        {% for source in contact_metrics.by_source %}
                            <div class="flex justify-between text-sm">
                                <span class="capitalize">{{ source.lead_source|default:"Unknown" }}</span>
                                <span class="font-medium">{{ source.count }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            <div>
                {% if contact_metrics.by_type %}
                    <div class="space-y-2">
                        <h5 class="text-sm font-medium text-gray-700">By Contact Type:</h5>
                        {% for type in contact_metrics.by_type %}
                            <div class="flex justify-between text-sm">
                                <span class="capitalize">{{ type.contact_type }}</span>
                                <span class="font-medium">{{ type.count }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Activity Metrics -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-tasks mr-2 text-purple-600"></i>Activity Summary
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <div class="text-2xl font-bold text-purple-600">{{ activity_metrics.total_activities }}</div>
                <div class="text-sm text-gray-600">Total Activities</div>
                <div class="mt-2 text-sm">
                    <span class="text-green-600">Completed: {{ activity_metrics.completed }}</span>
                </div>
            </div>
            <div>
                {% if activity_metrics.by_type %}
                    <div class="space-y-2">
                        <h5 class="text-sm font-medium text-gray-700">By Activity Type:</h5>
                        {% for type in activity_metrics.by_type %}
                            <div class="flex justify-between text-sm">
                                <span class="capitalize">{{ type.activity_type }}</span>
                                <span class="font-medium">{{ type.count }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Team Performance -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-user-friends mr-2 text-orange-600"></i>Team Performance
        </h3>
        {% if team_performance %}
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 font-medium text-gray-900">Team Member</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-900">Deals Created</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-900">Deals Won</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-900">Activities</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-900">Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in team_performance %}
                            <tr class="border-b border-gray-100">
                                <td class="py-3 px-4">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center mr-3">
                                            <span class="text-sm font-medium text-gray-700">
                                                {{ member.user.first_name|first }}{{ member.user.last_name|first }}
                                            </span>
                                        </div>
                                        <div>
                                            <div class="font-medium text-gray-900">{{ member.user.first_name }} {{ member.user.last_name }}</div>
                                            <div class="text-sm text-gray-500">{{ member.user.email }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900">{{ member.deals_created }}</td>
                                <td class="py-3 px-4 text-sm text-green-600 font-medium">{{ member.deals_won }}</td>
                                <td class="py-3 px-4 text-sm text-gray-900">{{ member.activities_completed }}</td>
                                <td class="py-3 px-4 text-sm font-medium text-gray-900">${{ member.revenue|floatformat:0 }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-chart-bar text-4xl mb-4"></i>
                <p>No team performance data available for the selected period.</p>
            </div>
        {% endif %}
    </div>
{% endblock %}
