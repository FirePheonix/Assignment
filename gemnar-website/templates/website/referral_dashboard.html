{% extends "website/base.html" %}
{% load static %}
{% block title %}Referral Dashboard - Gemnar{% endblock %}
{% block content %}
    <!-- Breadcrumb Navigation -->
    {% include 'website/components/breadcrumb.html' with breadcrumbs=breadcrumbs action_buttons=action_buttons %}
    {% csrf_token %}
    <div class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 py-8">
        <div class="container mx-auto px-4">
            <!-- Header -->
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">ğŸ“Š Your Referral Dashboard</h1>
                <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                    Track your referral performance and earn rewards for bringing new users to Gemnar
                </p>
            </div>
            <!-- Referral Code Card -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                {% if referral_code %}
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-6 md:mb-0">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Your Referral Code</h2>
                            <div class="flex items-center space-x-4">
                                <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-lg font-mono text-xl font-bold">
                                    {{ referral_code.code }}
                                </div>
                                <button onclick="copyToClipboard('{{ referral_code.code }}')"
                                        class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition">
                                    ğŸ“‹ Copy Code
                                </button>
                            </div>
                            <div class="mt-4">
                                <p class="text-gray-600 mb-2">Your referral link:</p>
                                <div class="flex items-center space-x-2">
                                    <input type="text"
                                           value="{{ referral_url }}"
                                           readonly
                                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm font-mono">
                                    <button onclick="copyToClipboard('{{ referral_url }}')"
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                        ğŸ“‹ Copy Link
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="text-center md:text-right">
                            <a href="{% url 'website:company_invitation' %}"
                               class="inline-block bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:from-pink-600 hover:to-purple-700 transform transition hover:scale-105 duration-300">
                                ğŸ¤ Invite Companies
                            </a>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">ğŸ”—</div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">Generate Your Referral Code</h2>
                        <p class="text-gray-600 mb-6">
                            Create your unique referral code to start earning rewards when people join through your link!
                        </p>
                        <button onclick="generateReferralCode()"
                                id="generate-btn"
                                class="inline-block bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:from-purple-600 hover:to-pink-600 transform transition hover:scale-105 duration-300">
                            Generate Referral Code
                        </button>
                    </div>
                {% endif %}
            </div>
            <!-- Stats Grid -->
            {% if referral_code %}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Total Points -->
                    <div class="bg-white rounded-lg shadow-lg p-6 text-center transform transition hover:scale-105 duration-300">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full text-white text-2xl mb-4">
                            ğŸ†
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Points</h3>
                        <p class="text-4xl font-bold text-gray-900">{{ referral_code.total_points }}</p>
                        <p class="text-sm text-gray-500 mt-2">Keep sharing to earn more!</p>
                    </div>
                    <!-- Total Clicks -->
                    <div class="bg-white rounded-lg shadow-lg p-6 text-center transform transition hover:scale-105 duration-300">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full text-white text-2xl mb-4">
                            ğŸ‘†
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Link Clicks</h3>
                        <p class="text-4xl font-bold text-gray-900">{{ referral_code.total_clicks }}</p>
                        <p class="text-sm text-gray-500 mt-2">People who clicked your link</p>
                    </div>
                    <!-- Total Signups -->
                    <div class="bg-white rounded-lg shadow-lg p-6 text-center transform transition hover:scale-105 duration-300">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-green-400 to-blue-500 rounded-full text-white text-2xl mb-4">
                            ğŸ‘¥
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">New Signups</h3>
                        <p class="text-4xl font-bold text-gray-900">{{ referral_code.total_signups }}</p>
                        <p class="text-sm text-gray-500 mt-2">Users who joined via your link</p>
                    </div>
                </div>
                <!-- Second Row Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Subscriptions -->
                    <div class="bg-white rounded-lg shadow-lg p-6 text-center transform transition hover:scale-105 duration-300">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-purple-400 to-pink-500 rounded-full text-white text-2xl mb-4">
                            ğŸ’³
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Subscriptions</h3>
                        <p class="text-4xl font-bold text-gray-900">{{ referral_code.total_subscriptions }}</p>
                        <p class="text-sm text-gray-500 mt-2">Users who subscribed</p>
                    </div>
                    <!-- Rewards Earned -->
                    <div class="bg-white rounded-lg shadow-lg p-6 text-center transform transition hover:scale-105 duration-300">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-green-400 to-teal-500 rounded-full text-white text-2xl mb-4">
                            ğŸ’°
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Rewards Earned</h3>
                        <p class="text-4xl font-bold text-gray-900">${{ referral_code.total_rewards_earned }}</p>
                        <p class="text-sm text-gray-500 mt-2">Total commission earned</p>
                    </div>
                    <!-- Badges -->
                    <div class="bg-white rounded-lg shadow-lg p-6 text-center transform transition hover:scale-105 duration-300">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-red-400 to-pink-500 rounded-full text-white text-2xl mb-4">
                            ğŸ…
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Badges Earned</h3>
                        <p class="text-4xl font-bold text-gray-900">{{ badges|length }}</p>
                        <p class="text-sm text-gray-500 mt-2">Achievement badges</p>
                    </div>
                </div>
            {% endif %}
            <!-- Badges Section -->
            {% if badges %}
                <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ… Your Badges</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for badge in badges %}
                            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-lg p-4 text-center">
                                <div class="text-3xl mb-2">ğŸ†</div>
                                <h3 class="font-semibold text-gray-800">{{ badge.get_badge_type_display }}</h3>
                                <p class="text-sm text-gray-600 mt-1">Earned {{ badge.earned_at|date:"M d, Y" }}</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“ˆ Recent Activity</h2>
                {% if recent_clicks or recent_signups or recent_subscriptions %}
                    <div class="space-y-4" id="activity-container">
                        {% for click in recent_clicks|slice:":15" %}
                            <div class="activity-item flex items-center justify-between p-4 bg-blue-50 rounded-lg transition-all duration-300"
                                 id="click-{{ click.id }}">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white">ğŸ‘†</div>
                                    <div>
                                        <p class="font-semibold text-gray-800">Link Click</p>
                                        <p class="text-sm text-gray-600">{{ click.timestamp|date:"M d, Y g:i A" }}</p>
                                        <div class="text-xs text-gray-500 mt-1">
                                            <span class="inline-block bg-gray-200 px-2 py-1 rounded mr-2">
                                                <strong>IP:</strong> {{ click.ip_address }}
                                            </span>
                                            <span class="inline-block bg-gray-200 px-2 py-1 rounded mr-2">
                                                <strong>Agent:</strong> {{ click.user_agent|truncatechars:30 }}
                                            </span>
                                            {% if click.referrer %}
                                                <span class="inline-block bg-gray-200 px-2 py-1 rounded">
                                                    <strong>Referrer:</strong> {{ click.referrer|truncatechars:25 }}
                                                </span>
                                            {% else %}
                                                <span class="inline-block bg-gray-200 px-2 py-1 rounded">
                                                    <strong>Referrer:</strong> Direct
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200"
                                        hx-delete="{% url 'website:delete_referral_activity' 'click' click.id %}"
                                        hx-target="#click-{{ click.id }}"
                                        hx-swap="outerHTML"
                                        hx-confirm="Are you sure you want to delete this click record?"
                                        onclick="this.closest('.activity-item').style.opacity='0.5';">
                                    ğŸ—‘ï¸ Delete
                                </button>
                            </div>
                        {% endfor %}
                        {% for signup in recent_signups|slice:":15" %}
                            <div class="activity-item flex items-center justify-between p-4 bg-green-50 rounded-lg transition-all duration-300"
                                 id="signup-{{ signup.id }}">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white">ğŸ‘¥</div>
                                    <div>
                                        <p class="font-semibold text-gray-800">New Signup: {{ signup.referred_user.username }}</p>
                                        <p class="text-sm text-gray-600">{{ signup.timestamp|date:"M d, Y g:i A" }}</p>
                                        <div class="text-xs text-gray-500 mt-1">
                                            <span class="inline-block bg-gray-200 px-2 py-1 rounded mr-2">
                                                <strong>User:</strong> {{ signup.referred_user.email }}
                                            </span>
                                            <span class="inline-block bg-gray-200 px-2 py-1 rounded">
                                                <strong>Joined:</strong> {{ signup.referred_user.date_joined|date:"M d, Y" }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200"
                                        hx-delete="{% url 'website:delete_referral_activity' 'signup' signup.id %}"
                                        hx-target="#signup-{{ signup.id }}"
                                        hx-swap="outerHTML"
                                        hx-confirm="Are you sure you want to delete this signup record?"
                                        onclick="this.closest('.activity-item').style.opacity='0.5';">
                                    ğŸ—‘ï¸ Delete
                                </button>
                            </div>
                        {% endfor %}
                        {% for subscription in recent_subscriptions|slice:":15" %}
                            <div class="activity-item flex items-center justify-between p-4 bg-purple-50 rounded-lg transition-all duration-300"
                                 id="subscription-{{ subscription.id }}">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center text-white">ğŸ’³</div>
                                    <div>
                                        <p class="font-semibold text-gray-800">New Subscription: {{ subscription.referred_user.username }}</p>
                                        <p class="text-sm text-gray-600">
                                            {{ subscription.timestamp|date:"M d, Y g:i A" }} - ${{ subscription.subscription_amount }}
                                        </p>
                                        <div class="text-xs text-gray-500 mt-1">
                                            <span class="inline-block bg-gray-200 px-2 py-1 rounded mr-2">
                                                <strong>Type:</strong> {{ subscription.subscription_type }}
                                            </span>
                                            <span class="inline-block bg-gray-200 px-2 py-1 rounded mr-2">
                                                <strong>Amount:</strong> ${{ subscription.subscription_amount }}
                                            </span>
                                            <span class="inline-block bg-gray-200 px-2 py-1 rounded">
                                                <strong>Reward:</strong> ${{ subscription.reward_amount }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200"
                                        hx-delete="{% url 'website:delete_referral_activity' 'subscription' subscription.id %}"
                                        hx-target="#subscription-{{ subscription.id }}"
                                        hx-swap="outerHTML"
                                        hx-confirm="Are you sure you want to delete this subscription record?"
                                        onclick="this.closest('.activity-item').style.opacity='0.5';">
                                    ğŸ—‘ï¸ Delete
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">ğŸ“Š</div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">No activity yet</h3>
                        <p class="text-gray-500 mb-6">Start sharing your referral link to see activity here!</p>
                        <a href="{% url 'website:company_invitation' %}"
                           class="inline-block bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:from-pink-600 hover:to-purple-700 transform transition hover:scale-105 duration-300">
                            ğŸ¤ Invite Your First Company
                        </a>
                    </div>
                {% endif %}
            </div>
            <!-- Action Buttons -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <a href="{% url 'website:leaderboard' %}"
                   class="bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold py-6 px-8 rounded-lg shadow-lg hover:from-blue-600 hover:to-purple-600 transform transition hover:scale-105 duration-300 text-center">
                    ğŸ† View Leaderboard
                </a>
                <a href="{% url 'website:company_invitation' %}"
                   class="bg-gradient-to-r from-pink-500 to-red-500 text-white font-bold py-6 px-8 rounded-lg shadow-lg hover:from-pink-600 hover:to-red-600 transform transition hover:scale-105 duration-300 text-center">
                    ğŸ¤ Invite More Companies
                </a>
            </div>
        </div>
    </div>
    <script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show success message
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = 'âœ… Copied!';
        button.className = button.className.replace('bg-gray-100', 'bg-green-100').replace('bg-blue-500', 'bg-green-500');
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.className = button.className.replace('bg-green-100', 'bg-gray-100').replace('bg-green-500', 'bg-blue-500');
        }, 2000);
    });
}

function generateReferralCode() {
    const button = document.getElementById('generate-btn');
    const originalText = button.textContent;
    
    // Show loading state
    button.textContent = 'Generating...';
    button.disabled = true;
    
    // Get CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "website:generate_referral_code" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show the generated referral code
            location.reload();
        } else {
            alert('Error: ' + data.message);
            button.textContent = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while generating the referral code.');
        button.textContent = originalText;
        button.disabled = false;
    });
}

// HTMX event handlers for fade-out effect
document.addEventListener('htmx:beforeRequest', function(evt) {
    if (evt.detail.elt.classList.contains('delete-btn')) {
        const activityItem = evt.detail.elt.closest('.activity-item');
        if (activityItem) {
            activityItem.style.transition = 'all 0.5s ease-out';
            activityItem.style.opacity = '0.5';
            activityItem.style.transform = 'translateX(20px)';
        }
    }
});

document.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.elt.classList.contains('delete-btn')) {
        const activityItem = evt.detail.elt.closest('.activity-item');
        if (activityItem && evt.detail.successful) {
            // Fade out and remove the element
            activityItem.style.opacity = '0';
            activityItem.style.transform = 'translateX(100px)';
            activityItem.style.height = '0';
            activityItem.style.marginBottom = '0';
            activityItem.style.padding = '0';
            
            setTimeout(() => {
                activityItem.remove();
                
                // Check if no more activities
                const container = document.getElementById('activity-container');
                if (container && container.children.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">ğŸ“Š</div>
                            <h3 class="text-xl font-semibold text-gray-700 mb-2">No activity yet</h3>
                            <p class="text-gray-500 mb-6">Start sharing your referral link to see activity here!</p>
                            <a href="{% url 'website:company_invitation' %}" class="inline-block bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:from-pink-600 hover:to-purple-700 transform transition hover:scale-105 duration-300">
                                ğŸ¤ Invite Your First Company
                            </a>
                        </div>
                    `;
                }
            }, 500);
        }
    }
});

// Add CSRF token to HTMX requests
document.addEventListener('htmx:configRequest', function(evt) {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    if (csrftoken) {
        evt.detail.headers['X-CSRFToken'] = csrftoken;
    }
});
    </script>
{% endblock %}
