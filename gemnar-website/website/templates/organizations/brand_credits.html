{% extends "website/base.html" %}
{% block title %}AI Credits - {{ brand.name }}{% endblock %}
{% block content %}
    <div class="max-w-7xl mx-auto px-4 py-10">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">AI Credits for {{ brand.name }}</h1>
                <p class="text-sm text-gray-500 mt-1">1 credit = $1 USD • Use credits for AI image & text generation</p>
            </div>
            <a href="{% url 'organization_detail' organization_pk=organization.id %}"
               class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900">← Back to Organization</a>
        </div>
        {% if added_amount %}
            <div class="mb-6 rounded-lg bg-green-50 border border-green-200 px-4 py-3 text-green-700 text-sm">
                ✅ Added ${{ added_amount }} credits to your balance.
            </div>
        {% endif %}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Balance & Add Credits -->
            <div class="space-y-6 lg:col-span-1">
                <div class="relative overflow-hidden rounded-xl bg-gradient-to-br from-indigo-600 via-indigo-500 to-blue-500 p-6 text-white shadow-lg">
                    <div class="absolute inset-0 opacity-20 bg-[radial-gradient(circle_at_30%_20%,white,transparent_60%)]"></div>
                    <div class="relative">
                        <div class="text-sm uppercase tracking-wide text-indigo-100">Current Balance</div>
                        <div class="mt-2 flex items-end gap-2">
                            <span class="text-5xl font-extrabold" id="credits-balance-display">{{ stats.current_balance }}</span>
                            <span class="text-indigo-100 font-medium mb-1">credits</span>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="text-indigo-200">Total Purchased</div>
                                <div class="font-semibold">${{ stats.total_purchased }}</div>
                            </div>
                            <div>
                                <div class="text-indigo-200">Total Used</div>
                                <div class="font-semibold">${{ stats.total_used }}</div>
                            </div>
                            <div>
                                <div class="text-indigo-200">Usage (30d)</div>
                                <div class="font-semibold">${{ stats.recent_usage_30d }}</div>
                            </div>
                            <div>
                                <div class="text-indigo-200">Transactions</div>
                                <div class="font-semibold">{{ stats.transaction_count }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6 bg-white rounded-xl shadow space-y-5">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        Add Credits <span class="text-xs font-normal text-gray-400">(1 = $1)</span>
                    </h2>
                    <div class="grid grid-cols-3 gap-3" id="quick-amounts">
                        {% for amt in quick_amounts %}
                            <button data-amount="{{ amt }}"
                                    class="quick-amt-btn px-3 py-2 text-sm rounded-lg border border-gray-300 hover:border-indigo-500 hover:text-indigo-600 font-medium bg-white">
                                ${{ amt }}
                            </button>
                        {% endfor %}
                    </div>
                    <div class="flex items-center gap-3">
                        <input id="custom-amount"
                               type="number"
                               min="1"
                               step="1"
                               placeholder="Custom $"
                               class="w-full rounded-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm" />
                        <button id="add-custom"
                                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-sm font-semibold">
                            Add
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 leading-relaxed">
                        Payments securely processed with Stripe. Superusers can instantly refill without checkout.
                    </p>
                    <div id="add-credits-feedback" class="text-sm"></div>
                </div>
                <div class="p-6 bg-white rounded-xl shadow">
                    <h2 class="text-lg font-semibold mb-3">Credit Packages</h2>
                    <div class="space-y-3 max-h-72 overflow-y-auto pr-1">
                        {% for p in packages %}
                            <div class="flex items-center justify-between border rounded-lg px-3 py-2 text-sm">
                                <div>
                                    <div class="font-semibold">{{ p.name }}</div>
                                    <div class="text-xs text-gray-500">{{ p.total_credits }} credits for ${{ p.price_usd }}</div>
                                </div>
                                <button data-amount="{{ p.price_usd }}"
                                        class="quick-amt-btn text-indigo-600 hover:text-indigo-700 font-medium text-xs">
                                    Select
                                </button>
                            </div>
                        {% empty %}
                            <div class="text-gray-500 text-sm">No packages available.</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="p-6 bg-white rounded-xl shadow">
                    <h2 class="text-lg font-semibold mb-3">Apply Coupon</h2>
                    <form id="coupon-form" class="flex flex-col sm:flex-row gap-3 items-start">
                        {% csrf_token %}
                        <input type="text"
                               id="coupon-code"
                               name="code"
                               placeholder="Enter coupon code"
                               class="flex-1 border rounded px-3 py-2" />
                        <button type="submit"
                                class="px-4 py-2 bg-pink-600 text-white rounded hover:bg-pink-700">Apply</button>
                    </form>
                    <div id="coupon-feedback" class="mt-3 text-sm"></div>
                </div>
            </div>
            <!-- Transactions Table -->
            <div class="lg:col-span-2">
                <div class="p-6 bg-white rounded-xl shadow">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">Recent Transactions</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead>
                                <tr class="text-left text-gray-500">
                                    <th class="py-2 pr-4">Date</th>
                                    <th class="py-2 pr-4">Type</th>
                                    <th class="py-2 pr-4">Amount</th>
                                    <th class="py-2 pr-4">Balance After</th>
                                    <th class="py-2">Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for t in transactions %}
                                    <tr class="border-t hover:bg-gray-50 transition">
                                        <td class="py-2 pr-4 whitespace-nowrap">{{ t.created_at|date:"Y-m-d H:i" }}</td>
                                        <td class="py-2 pr-4">{{ t.get_transaction_type_display }}</td>
                                        <td class="py-2 pr-4">{{ t.amount }}</td>
                                        <td class="py-2 pr-4">{{ t.balance_after }}</td>
                                        <td class="py-2">{{ t.description|default:"—" }}</td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td class="py-6 text-gray-500" colspan="5">No transactions yet.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-8 p-4 bg-white rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-3">Credit Packages</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                {% for p in packages %}
                    <div class="p-4 border rounded-lg">
                        <div class="font-semibold">{{ p.name }}</div>
                        <div class="text-2xl font-bold mt-1">{{ p.total_credits }} credits</div>
                        {% if p.bonus_credits and p.bonus_credits|floatformat != '0' %}
                            <div class="text-green-700 text-sm">+{{ p.bonus_credits }} bonus</div>
                        {% endif %}
                        <div class="text-gray-600 mt-2">${{ p.price_usd }}</div>
                        <div class="text-sm text-gray-500 mt-1">{{ p.credits_per_dollar|floatformat:2 }} credits/$</div>
                    </div>
                {% empty %}
                    <div class="text-gray-500">No packages available.</div>
                {% endfor %}
            </div>
        </div>
        <script>
// CSRF helper
function getCsrfToken() {
    const cookie = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
    if (cookie) return cookie;
    const input = document.querySelector('input[name=csrfmiddlewaretoken]');
    return input ? input.value : '';
}
// Add Credits Logic
(function() {
    const feedback = document.getElementById('add-credits-feedback');
    const balanceDisplay = document.getElementById('credits-balance-display');
    const endpoint = '{% url "brand_credit_create_checkout_session" organization_pk=organization.id brand_pk=brand.id %}';
    function postAmount(amount) {
        feedback.textContent = 'Processing...';
        feedback.className = 'text-sm text-gray-600';
        fetch(endpoint, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({ amount })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                if (data.superuser) {
                    feedback.textContent = data.message;
                    feedback.className = 'text-sm text-green-600';
                    if (data.new_balance && balanceDisplay) balanceDisplay.textContent = data.new_balance;
                } else if (data.checkout_url) {
                    feedback.textContent = 'Redirecting to secure checkout...';
                    feedback.className = 'text-sm text-indigo-600';
                    window.location = data.checkout_url;
                } else {
                    feedback.textContent = 'Credits added.';
                    feedback.className = 'text-sm text-green-600';
                }
            } else {
                feedback.textContent = data.error || 'Failed to start purchase.';
                feedback.className = 'text-sm text-red-600';
            }
        })
        .catch(err => {
            feedback.textContent = 'Network error: ' + err.message;
            feedback.className = 'text-sm text-red-600';
        });
    }
    document.querySelectorAll('.quick-amt-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const amt = parseFloat(btn.getAttribute('data-amount'));
            if (amt > 0) postAmount(amt);
        });
    });
    const customBtn = document.getElementById('add-custom');
    if (customBtn) {
        customBtn.addEventListener('click', () => {
            const val = parseFloat(document.getElementById('custom-amount').value);
            if (!val || val <= 0) {
                feedback.textContent = 'Enter a valid amount';
                feedback.className = 'text-sm text-red-600';
                return;
            }
            postAmount(val);
        });
    }
})();
        </script>
        <script>
    (function() {
    const form = document.getElementById('coupon-form');
      if (!form) return;
      const codeInput = document.getElementById('coupon-code');
      const feedback = document.getElementById('coupon-feedback');
      const balanceEls = document.querySelectorAll('[data-balance]');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const code = (codeInput.value || '').trim();
        if (!code) { return; }
        feedback.textContent = 'Applying coupon...';
        feedback.className = 'mt-3 text-sm text-gray-600';
        try {
          const resp = await fetch(
            '{% url "apply_coupon" organization_pk=organization.id brand_pk=brand.id %}',
            {
              method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken(),
                            },
              body: JSON.stringify({ code })
            }
          );
          const data = await resp.json();
          if (resp.ok && data.success) {
            feedback.textContent = data.message || 'Coupon applied.';
            feedback.className = 'mt-3 text-sm text-green-700';
            // Update balance display on this page
            const balanceEl = document.querySelector(
              '.grid .text-3xl.font-extrabold'
            );
            if (balanceEl && data.credits_balance) {
              balanceEl.textContent = data.credits_balance;
            }
          } else {
            feedback.textContent = data.error || 'Failed to apply coupon.';
            feedback.className = 'mt-3 text-sm text-red-700';
          }
        } catch (err) {
          feedback.textContent = 'Network error applying coupon.';
          feedback.className = 'mt-3 text-sm text-red-700';
        }
      });
    })();
        </script>
    </div>
{% endblock %}
