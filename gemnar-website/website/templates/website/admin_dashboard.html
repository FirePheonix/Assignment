{% extends "website/base.html" %}
{% load static %}
{% block title %}
    Admin Dashboard - Gemnar
{% endblock title %}
{% block description %}Admin dashboard for monitoring system performance and user analytics.{% endblock %}
{% block extra_head %}
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes pulse {
            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        /* Styles for circular progress bars */
        .progress-circle-bg {
            fill: none;
            stroke: #e5e7eb;
            /* gray-200 */
        }

        .progress-circle-fg {
            fill: none;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.3s ease-in-out;
        }

        .stroke-healthy { stroke: #10b981; }
        .stroke-warning { stroke: #f59e0b; }
        .stroke-error { stroke: #ef4444; }

        /* Chart canvas styling */
        .chart-canvas {
            max-height: 300px;
        }
        
        .mini-chart-canvas {
            max-height: 60px;
        }

        .dashboard-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* Mobile-first responsive dashboard card */
        @media (max-width: 768px) {
            .dashboard-card {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 6px;
            }
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        /* Mobile metric cards */
        @media (max-width: 768px) {
            .metric-card {
                padding: 1rem;
                min-height: 100px;
            }
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        /* Mobile metric values */
        @media (max-width: 768px) {
            .metric-value {
                font-size: 1.5rem;
                margin-bottom: 0.25rem;
            }
        }
        
        .progress-bar {
            background: #e5e7eb;
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
        }
        
        #progress-bar {
            width: 0%;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .status-healthy { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-error { background-color: #ef4444; }
        
        /* Enhanced terminal styling with better colors and mobile support */
        .log-container {
            background: #0f172a; /* Much darker background for better contrast */
            color: #e2e8f0; /* Light gray text for better readability */
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Consolas', 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 1rem;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #334155;
            line-height: 1.4;
        }
        
        /* Mobile terminal styling */
        @media (max-width: 768px) {
            .log-container {
                font-size: 0.75rem;
                padding: 0.75rem;
                max-height: 300px;
                border-radius: 6px;
                line-height: 1.3;
            }
        }
        
        /* Fix all terminal text colors for better contrast */
        .log-container * {
            color: #e2e8f0 !important;
            font-family: inherit !important;
        }
        
        .log-container p {
            color: #e2e8f0 !important;
            margin: 2px 0 !important;
        }
        
        .log-container div {
            color: #e2e8f0 !important;
            margin: 2px 0 !important;
        }
        
        /* Enhanced log type colors with better contrast */
        .log-container .log-error {
            color: #fb7185 !important; /* Lighter red for better visibility */
        }
        
        .log-container .log-warning {
            color: #fbbf24 !important; /* Amber/yellow for warnings */
        }
        
        .log-container .log-success {
            color: #34d399 !important; /* Bright green for success */
        }
        
        .log-container .log-info {
            color: #60a5fa !important; /* Light blue for info */
        }
        
        .log-container .log-debug {
            color: #9ca3af !important; /* Medium gray for debug */
        }
        
        /* Deployment console with same enhanced styling */
        #console-output, #deployment-log-container {
            background: #0f172a !important;
            color: #e2e8f0 !important;
            border: 1px solid #334155 !important;
        }
        
        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        /* Mobile button styling */
        @media (max-width: 768px) {
            .refresh-btn {
                padding: 0.75rem 1rem;
                font-size: 0.8rem;
                border-radius: 4px;
            }
        }
        
        .refresh-btn:hover {
            background: #2563eb;
        }
        
        /* Connection table styles with mobile responsiveness */
        .connection-table {
            font-size: 0.875rem;
        }
        
        @media (max-width: 768px) {
            .connection-table {
                font-size: 0.75rem;
            }
        }
        
        .connection-table th {
            background-color: #f9fafb;
            font-weight: 600;
            padding: 0.75rem 0.5rem;
        }
        
        @media (max-width: 768px) {
            .connection-table th {
                padding: 0.5rem 0.25rem;
            }
        }
        
        .connection-table tr:hover {
            background-color: #f3f4f6;
        }
        .flag-emoji {
            font-size: 1.2em;
        }
        .whois-info {
            max-width: 200px;
        }
        .whois-org {
            max-width: 180px;
        }
        .protocol-badge {
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        /* Mobile table improvements */
        @media (max-width: 768px) {
            .whois-info {
                max-width: 120px;
            }
            .whois-org {
                max-width: 100px;
            }
            .protocol-badge {
                font-size: 0.65rem;
                padding: 0.25rem 0.5rem;
            }
        }
        
        /* Mobile responsive headers */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.75rem !important;
                line-height: 1.2;
            }
            h3 {
                font-size: 1.25rem !important;
                line-height: 1.3;
            }
            .text-3xl {
                font-size: 1.75rem !important;
            }
            .text-xl {
                font-size: 1.25rem !important;
            }
        }
        
        /* Mobile tab styling */
        @media (max-width: 768px) {
            .log-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
                border-radius: 4px;
            }
        }
        
        /* Mobile-friendly progress circles */
        @media (max-width: 768px) {
            .dashboard-card .relative {
                width: 80px !important;
                height: 80px !important;
            }
            .dashboard-card .w-24 {
                width: 80px !important;
            }
            .dashboard-card .h-24 {
                height: 80px !important;
            }
        }
        
        /* Mobile navigation improvements */
        @media (max-width: 768px) {
            .nav.flex {
                flex-wrap: wrap;
                gap: 0.25rem;
            }
        }
        
        /* Better mobile spacing */
        @media (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .px-4 {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            .gap-6 {
                gap: 1rem;
            }
            .gap-8 {
                gap: 1.5rem;
            }
        }
        
        /* Mobile table overflow handling */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 768px) {
            .table-container {
                margin: 0 -1rem;
                padding: 0 1rem;
            }
        }
        
        /* Chart canvas styling */
        .chart-canvas {
            max-height: 300px;
            width: 100%;
        }
    </style>
{% endblock extra_head %}
{% block content %}
    <!-- Breadcrumb Navigation -->
    {% include 'website/components/breadcrumb.html' with breadcrumbs=breadcrumbs action_buttons=action_buttons %}
    <div class="min-h-screen bg-gray-50 py-4 md:py-8">
        {% csrf_token %}
        <div class="container mx-auto px-2 md:px-4">
            <!-- Header -->
            <div class="mb-4 md:mb-8">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Admin Dashboard</h1>
                <p class="text-gray-600 text-sm md:text-base">System monitoring and analytics</p>
                <div class="mt-4 flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="refreshDashboard()" class="refresh-btn">üîÑ Refresh Data</button>
                        <button onclick="reloadEnvironmentVariables()"
                                class="refresh-btn"
                                id="reload-env-btn">üîÑ Reload Env</button>
                    </div>
                    <span class="text-xs md:text-sm text-gray-500" id="last-updated">
                        Last updated: {{ initial_data.timestamp|date:"M d, Y H:i:s" }}
                    </span>
                </div>
            </div>
            <!-- System Metrics -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 md:gap-6 mb-4 md:mb-8">
                <div class="metric-card">
                    <div class="metric-value">{{ initial_data.sessions.active_count }}</div>
                    <div class="text-xs md:text-sm opacity-90">Active Sessions</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{{ initial_data.modules.total_modules }}</div>
                    <div class="text-xs md:text-sm opacity-90">Python Modules</div>
                    <div class="text-xs opacity-75 mt-1">
                        <a href="{% url 'memory_dashboard' %}"
                           class="text-white hover:text-blue-200 underline">View Memory Analysis ‚Üí</a>
                    </div>
                </div>
                <!-- CPU Usage -->
                <div class="dashboard-card flex flex-col items-center justify-center p-3 md:p-4">
                    <h3 class="text-sm md:text-lg font-semibold text-gray-700 mb-2">CPU Usage</h3>
                    <div class="relative w-16 h-16 md:w-24 md:h-24 mb-3">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="progress-circle-bg" stroke-width="10" cx="50" cy="50" r="45"></circle>
                            <circle class="progress-circle-fg
                            {% if initial_data.system.cpu.percent > 80 %}
                                stroke-error
                            {% elif initial_data.system.cpu.percent > 60 %}
                                stroke-warning
                            {% else %}
                                stroke-healthy
                            {% endif %}
                            " stroke-width="10" cx="50" cy="50" r="45" stroke-dasharray="282.6" style="stroke-dashoffset: calc(282.6 - (282.6 * {{ initial_data.system.cpu.percent }}) / 100)"></circle>
                        </svg>
                        <span class="absolute text-sm md:text-xl font-bold text-gray-800 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                            {{ initial_data.system.cpu.percent|floatformat:1 }}%
                        </span>
                    </div>
                    {% if latest_stats %}
                        <div class="w-full">
                            <canvas id="miniCpuChart" class="chart-canvas mini-chart-canvas"></canvas>
                            <div class="text-xs text-gray-500 text-center mt-1">24h trend</div>
                        </div>
                    {% endif %}
                </div>
                <!-- Memory Usage -->
                <div class="dashboard-card flex flex-col items-center justify-center p-3 md:p-4">
                    <h3 class="text-sm md:text-lg font-semibold text-gray-700 mb-2">Memory Usage</h3>
                    <div class="relative w-16 h-16 md:w-24 md:h-24 mb-3">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="progress-circle-bg" stroke-width="10" cx="50" cy="50" r="45"></circle>
                            <circle class="progress-circle-fg
                            {% if initial_data.system.memory.percent > 80 %}
                                stroke-error
                            {% elif initial_data.system.memory.percent > 60 %}
                                stroke-warning
                            {% else %}
                                stroke-healthy
                            {% endif %}
                            " stroke-width="10" cx="50" cy="50" r="45" stroke-dasharray="282.6" style="stroke-dashoffset: calc(282.6 - (282.6 * {{ initial_data.system.memory.percent }}) / 100)"></circle>
                        </svg>
                        <span class="absolute text-sm md:text-xl font-bold text-gray-800 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                            {{ initial_data.system.memory.percent|floatformat:1 }}%
                        </span>
                    </div>
                    {% if latest_stats %}
                        <div class="w-full">
                            <canvas id="miniMemoryChart" class="chart-canvas mini-chart-canvas"></canvas>
                            <div class="text-xs text-gray-500 text-center mt-1">24h trend</div>
                        </div>
                    {% endif %}
                </div>
                <!-- Disk Usage -->
                <div class="dashboard-card flex flex-col items-center justify-center p-3 md:p-4">
                    <h3 class="text-sm md:text-lg font-semibold text-gray-700 mb-2">Disk Usage</h3>
                    <div class="relative w-16 h-16 md:w-24 md:h-24 mb-3">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="progress-circle-bg" stroke-width="10" cx="50" cy="50" r="45"></circle>
                            <circle class="progress-circle-fg
                            {% if initial_data.system.disk.percent > 80 %}
                                stroke-error
                            {% elif initial_data.system.disk.percent > 60 %}
                                stroke-warning
                            {% else %}
                                stroke-healthy
                            {% endif %}
                            " stroke-width="10" cx="50" cy="50" r="45" stroke-dasharray="282.6" style="stroke-dashoffset: calc(282.6 - (282.6 * {{ initial_data.system.disk.percent }}) / 100)"></circle>
                        </svg>
                        <span class="absolute text-sm md:text-xl font-bold text-gray-800 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                            {{ initial_data.system.disk.percent|floatformat:1 }}%
                        </span>
                    </div>
                    {% if latest_stats %}
                        <div class="w-full">
                            <canvas id="miniDiskChart" class="chart-canvas mini-chart-canvas"></canvas>
                            <div class="text-xs text-gray-500 text-center mt-1">24h trend</div>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- System Statistics Charts (1h default) -->
            {% if latest_stats %}
                <div class="dashboard-card mb-4 md:mb-8">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
                        <h3 class="text-lg md:text-xl font-bold text-gray-800">System Statistics (1h)</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-xs md:text-sm text-gray-500">{{ stats_count }} data points</span>
                            <button onclick="refreshSystemStats()" class="refresh-btn">üîÑ Refresh</button>
                        </div>
                    </div>
                    <!-- Current Status Cards -->
                    <div class="grid grid-cols-2 lg:grid-cols-6 gap-3 md:gap-4 mb-6">
                        <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                            <div class="text-xs md:text-sm font-medium text-blue-800">Memory</div>
                            <div class="text-lg md:text-xl font-bold {% if latest_stats.memory_percent > 80 %}text-red-600{% elif latest_stats.memory_percent > 60 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{ latest_stats.memory_percent|floatformat:1 }}%
                            </div>
                            <div class="text-xs text-blue-600">
                                {{ latest_stats.memory_used|filesizeformat }} / {{ latest_stats.memory_total|filesizeformat }}
                            </div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-3 border border-green-200">
                            <div class="text-xs md:text-sm font-medium text-green-800">CPU</div>
                            <div class="text-lg md:text-xl font-bold {% if latest_stats.cpu_percent > 80 %}text-red-600{% elif latest_stats.cpu_percent > 60 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{ latest_stats.cpu_percent|floatformat:1 }}%
                            </div>
                            <div class="text-xs text-green-600">{{ latest_stats.cpu_count }} cores</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-3 border border-purple-200">
                            <div class="text-xs md:text-sm font-medium text-purple-800">Disk</div>
                            <div class="text-lg md:text-xl font-bold {% if latest_stats.disk_percent > 90 %}text-red-600{% elif latest_stats.disk_percent > 80 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{ latest_stats.disk_percent|floatformat:1 }}%
                            </div>
                            <div class="text-xs text-purple-600">
                                {{ latest_stats.disk_used|filesizeformat }} / {{ latest_stats.disk_total|filesizeformat }}
                            </div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-3 border border-yellow-200">
                            <div class="text-xs md:text-sm font-medium text-yellow-800">Sessions</div>
                            <div class="text-lg md:text-xl font-bold text-yellow-600">{{ latest_stats.active_sessions }}</div>
                            <div class="text-xs text-yellow-600">Active users</div>
                        </div>
                        <div class="bg-indigo-50 rounded-lg p-3 border border-indigo-200">
                            <div class="text-xs md:text-sm font-medium text-indigo-800">Users</div>
                            <div class="text-lg md:text-xl font-bold text-indigo-600">{{ latest_stats.user_count }}</div>
                            <div class="text-xs text-indigo-600">Total in system</div>
                        </div>
                        <div class="bg-pink-50 rounded-lg p-3 border border-pink-200">
                            <div class="text-xs md:text-sm font-medium text-pink-800">Brands</div>
                            <div class="text-lg md:text-xl font-bold text-pink-600">{{ latest_stats.brand_count }}</div>
                            <div class="text-xs text-pink-600">Total brands</div>
                        </div>
                    </div>
                    {% if stats_count > 0 %}
                        <!-- Time Span Selector -->
                        <div class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <h4 class="text-lg font-semibold text-gray-700">System Analytics</h4>
                                <div class="flex flex-wrap gap-2">
                                    <label class="text-sm text-gray-600 mr-2">Time Range:</label>
                                    <select id="timeSpanSelector"
                                            class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="1h" selected>1 Hour</option>
                                        <option value="12h">12 Hours</option>
                                        <option value="24h">24 Hours</option>
                                        <option value="2d">2 Days</option>
                                        <option value="5d">5 Days</option>
                                    </select>
                                    <button id="refreshChartsBtn"
                                            class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
                                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Charts Section -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                            <div class="bg-white rounded-lg border border-gray-200 p-4">
                                <h4 id="sessionsChartTitle"
                                    class="text-sm md:text-base font-semibold text-gray-700 mb-3">
                                    Active Sessions (1 Hour)
                                </h4>
                                <canvas id="sessionsChart" class="chart-canvas"></canvas>
                            </div>
                            <div class="bg-white rounded-lg border border-gray-200 p-4">
                                <h4 id="databaseChartTitle"
                                    class="text-sm md:text-base font-semibold text-gray-700 mb-3">
                                    Database Growth (1 Hour)
                                </h4>
                                <canvas id="databaseChart" class="chart-canvas"></canvas>
                            </div>
                            <div class="bg-white rounded-lg border border-gray-200 p-4">
                                <h4 class="text-sm md:text-base font-semibold text-gray-700 mb-3">Collection Info</h4>
                                <div class="text-center">
                                    <div class="text-2xl md:text-3xl font-bold text-gray-600 mb-2">{{ stats_count }}</div>
                                    <div class="text-sm text-gray-500 mb-4">Data points collected</div>
                                    <div class="text-xs text-gray-400">
                                        Collection Period: 1 Hour (Dynamic)
                                        <br>
                                        Latest: {{ latest_stats.timestamp|date:"M d, Y H:i:s" }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Initialize Charts Script -->
                        <script>
                            // Chart data from Django
                            {% if chart_data %}
                            const systemChartData = {
                                timestamps: {{ chart_data.timestamps|safe }},
                                memory_percent: {{ chart_data.memory_percent|safe }},
                                cpu_percent: {{ chart_data.cpu_percent|safe }},
                                disk_percent: {{ chart_data.disk_percent|safe }},
                                active_sessions: {{ chart_data.active_sessions|safe }},
                                user_count: {{ chart_data.user_count|safe }},
                                brand_count: {{ chart_data.brand_count|safe }}
                            };
                            
                            // Debug output
                            console.log('Chart data loaded:', systemChartData);
                            console.log('Timestamps count:', JSON.parse(systemChartData.timestamps).length);
                            
                            // Initialize charts when ready
                            if (typeof Chart !== 'undefined') {
                                document.addEventListener('DOMContentLoaded', function() {
                                    console.log('Initializing system charts...');
                                    initializeSystemCharts(systemChartData);
                                });
                            } else {
                                console.error('Chart.js not loaded');
                            }
                            {% else %}
                            console.log('No chart data available');
                            {% endif %}
                        </script>
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <h4 class="text-lg font-medium mb-2">No historical data available</h4>
                            <p class="text-sm mb-4">System monitoring data will appear here once collection begins.</p>
                            <p class="text-xs text-gray-400">
                                Run the <code class="bg-gray-100 px-2 py-1 rounded">collect_system_stats</code> management command to start collecting data.
                            </p>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
            <!-- Real-time Logs -->
            <div class="dashboard-card mb-4 md:mb-8">
                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-4 gap-3">
                    <div class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                        <h3 class="text-lg md:text-xl font-bold text-gray-800">Real-time Logs</h3>
                        <div class="flex items-center space-x-2 text-xs md:text-sm text-gray-600">
                            <span>üïê Server Time:</span>
                            <span id="server-time" class="font-mono text-blue-600">{{ initial_data.timestamp|date:"Y-m-d H:i:s" }}</span>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-1 md:gap-2">
                        <button onclick="generateTestLog()" class="refresh-btn">üìù Test</button>
                        <button onclick="debugLogStream()" class="refresh-btn">üîç Debug</button>
                        <button onclick="restartLogStream()" class="refresh-btn">üîÑ Restart</button>
                    </div>
                </div>
                <!-- Log Source Tabs -->
                <div class="mb-4 overflow-x-auto">
                    <nav class="flex space-x-1 bg-gray-100 p-1 rounded-lg min-w-max">
                        <button onclick="switchLogSource('django')"
                                id="tab-django"
                                class="log-tab px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors duration-150 bg-blue-600 text-white whitespace-nowrap">
                            üêç Django
                        </button>
                        <button onclick="switchLogSource('errors')"
                                id="tab-errors"
                                class="log-tab px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors duration-150 text-gray-600 hover:text-gray-800 whitespace-nowrap">
                            ‚ùå Errors
                        </button>
                        <button onclick="switchLogSource('requests')"
                                id="tab-requests"
                                class="log-tab px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors duration-150 text-gray-600 hover:text-gray-800 whitespace-nowrap">
                            üì° Requests
                        </button>
                        <button onclick="switchLogSource('uvicorn')"
                                id="tab-uvicorn"
                                class="log-tab px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors duration-150 text-gray-600 hover:text-gray-800 whitespace-nowrap">
                            üöÄ Uvicorn
                        </button>
                        <button onclick="switchLogSource('nginx')"
                                id="tab-nginx"
                                class="log-tab px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors duration-150 text-gray-600 hover:text-gray-800 whitespace-nowrap">
                            üåê Nginx
                        </button>
                        <button onclick="switchLogSource('nginx_access')"
                                id="tab-nginx_access"
                                class="log-tab px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors duration-150 text-gray-600 hover:text-gray-800 whitespace-nowrap">
                            üì• Access
                        </button>
                        <button onclick="switchLogSource('nginx_error')"
                                id="tab-nginx_error"
                                class="log-tab px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors duration-150 text-gray-600 hover:text-gray-800 whitespace-nowrap">
                            ‚ùå Error
                        </button>
                        <button onclick="switchLogSource('system')"
                                id="tab-system"
                                class="log-tab px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors duration-150 text-gray-600 hover:text-gray-800 whitespace-nowrap">
                            üñ•Ô∏è System
                        </button>
                    </nav>
                </div>
                <div id="log-container" class="log-container">
                    <div id="connection-status-bar"
                         class="mb-2 p-2 bg-gray-100 rounded border text-xs md:text-sm">
                        <span id="connection-status-text">Status: Initializing...</span>
                        <span id="connection-details" class="ml-2 text-gray-600"></span>
                    </div>
                    <p>Connecting to log stream...</p>
                </div>
            </div>
            <!-- Log Files Status Panel -->
            <div class="dashboard-card mb-4 md:mb-8">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
                    <h3 class="text-lg md:text-xl font-bold text-gray-800">Log Files Status</h3>
                    <span class="text-xs md:text-sm text-gray-500">{{ log_status|length }} log sources monitored</span>
                </div>
                <div class="table-container">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">Source</th>
                                <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">Path</th>
                                <th class="text-center py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">Status</th>
                                <th class="text-center py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">Readable</th>
                                <th class="text-right py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">Size</th>
                                <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700 hidden sm:table-cell">
                                    Permissions
                                </th>
                                <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700 hidden md:table-cell">Owner</th>
                                <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700 hidden lg:table-cell">
                                    Last Updated
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in log_status %}
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-800">
                                        <div class="flex items-center">
                                            {% if log.type == 'file' %}
                                                <span class="mr-1 md:mr-2">üìÑ</span>
                                            {% else %}
                                                <span class="mr-1 md:mr-2">üì∞</span>
                                            {% endif %}
                                            <span class="font-medium">{{ log.name }}</span>
                                        </div>
                                    </td>
                                    <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-600">
                                        <div class="font-mono text-xs truncate" title="{{ log.path }}">{{ log.path|truncatechars:30 }}</div>
                                    </td>
                                    <td class="py-2 px-2 md:px-4 text-center">
                                        {% if log.exists %}
                                            <span class="inline-flex items-center px-1.5 md:px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                ‚úÖ <span class="hidden sm:inline ml-1">Exists</span>
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center px-1.5 md:px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                ‚ùå <span class="hidden sm:inline ml-1">Missing</span>
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="py-2 px-2 md:px-4 text-center">
                                        {% if log.readable %}
                                            <span class="inline-flex items-center px-1.5 md:px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                ‚úÖ <span class="hidden sm:inline ml-1">Yes</span>
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center px-1.5 md:px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                ‚ùå <span class="hidden sm:inline ml-1">No</span>
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="py-2 px-2 md:px-4 text-right text-xs md:text-sm text-gray-600">
                                        {% if log.type == 'file' %}
                                            {{ log.size_human }}
                                        {% else %}
                                            <span class="text-gray-400">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-600 hidden sm:table-cell">
                                        <span class="font-mono text-xs">{{ log.permissions }}</span>
                                    </td>
                                    <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-600 hidden md:table-cell">
                                        <div class="text-xs">
                                            <div>{{ log.owner }}</div>
                                            {% if log.group != log.owner %}<div class="text-gray-400">{{ log.group }}</div>{% endif %}
                                        </div>
                                    </td>
                                    <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-600 hidden lg:table-cell">
                                        {% if log.last_updated %}
                                            {{ log.last_updated|date:"Y-m-d H:i:s" }}
                                        {% else %}
                                            <span class="text-gray-400">N/A</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if log.error %}
                                    <tr class="border-b bg-red-50">
                                        <td colspan="8" class="py-2 px-2 md:px-4 text-xs md:text-sm text-red-600">
                                            <div class="flex items-center">
                                                <span class="mr-2">‚ö†Ô∏è</span>
                                                <span class="font-medium">Error:</span>
                                                <span class="ml-2">{{ log.error }}</span>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% empty %}
                                <tr>
                                    <td colspan="8" class="py-8 text-center text-gray-500">No log sources configured</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-8">
                <!-- Top Memory Processes -->
                {% if initial_data.system.memory.processes %}
                    <div class="dashboard-card">
                        <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">
                            Top Memory Processes ({{ initial_data.system.memory.processes|length }})
                        </h3>
                        <div class="table-container">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">PID</th>
                                        <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">User</th>
                                        <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">Process</th>
                                        <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">Command Line</th>
                                        <th class="text-right py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">Memory (MB)</th>
                                        <th class="text-right py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">Memory %</th>
                                        <th class="text-right py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700 hidden md:table-cell">CPU %</th>
                                        <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700 hidden lg:table-cell">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for process in initial_data.system.memory.processes %}
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-600 font-mono">
                                                <span class="bg-gray-100 px-2 py-1 rounded">{{ process.pid }}</span>
                                            </td>
                                            <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-blue-600">{{ process.username|default:"N/A" }}</td>
                                            <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-800 font-medium">{{ process.name }}</td>
                                            <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-600">
                                                <div class="max-w-md overflow-hidden">
                                                    <span class="font-mono text-xs bg-gray-50 px-2 py-1 rounded block truncate"
                                                          title="{{ process.full_cmdline|default:process.name }}">
                                                        {{ process.cmdline|default:process.name }}
                                                    </span>
                                                </div>
                                            </td>
                                            <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-600 text-right font-mono">{{ process.memory_mb }}</td>
                                            <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-right font-mono">
                                                <span class="{% if process.memory_percent > 5 %}text-red-600 font-bold{% elif process.memory_percent > 2 %}text-yellow-600{% else %}text-gray-600{% endif %}">
                                                    {{ process.memory_percent }}%
                                                </span>
                                            </td>
                                            <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-600 text-right font-mono hidden md:table-cell">
                                                {{ process.cpu_percent|default:"0.0" }}%
                                            </td>
                                            <td class="py-2 px-2 md:px-4 text-xs md:text-sm hidden lg:table-cell">
                                                <span class="{% if process.status == 'running' %}text-green-600{% elif process.status == 'sleeping' %}text-blue-600{% elif process.status == 'zombie' %}text-red-600{% else %}text-gray-600{% endif %} capitalize">
                                                    {{ process.status|default:"unknown" }}
                                                </span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <!-- Process Details Expandable Section -->
                        <div class="mt-4 text-xs text-gray-500">
                            <details class="bg-gray-50 p-3 rounded">
                                <summary class="cursor-pointer font-medium text-gray-700 hover:text-gray-900">View Additional Process Details</summary>
                                <div class="mt-3 space-y-2">
                                    {% for process in initial_data.system.memory.processes %}
                                        <div class="border-b border-gray-200 pb-2">
                                            <div class="font-medium text-gray-800">PID {{ process.pid }} - {{ process.name }}</div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-1 text-xs">
                                                <div>
                                                    <strong>Parent PID:</strong> {{ process.ppid|default:"N/A" }}
                                                </div>
                                                <div>
                                                    <strong>Threads:</strong> {{ process.num_threads|default:"N/A" }}
                                                </div>
                                                <div>
                                                    <strong>Created:</strong> {{ process.created|default:"N/A" }}
                                                </div>
                                                <div>
                                                    <strong>Working Dir:</strong>
                                                    <span class="font-mono bg-white px-1 rounded text-xs">{{ process.cwd|default:"N/A" }}</span>
                                                </div>
                                                <div class="md:col-span-2">
                                                    <strong>Executable:</strong>
                                                    <span class="font-mono bg-white px-1 rounded text-xs">{{ process.exe|default:"N/A" }}</span>
                                                </div>
                                                <div class="md:col-span-2">
                                                    <strong>Full Command:</strong>
                                                    <span class="font-mono bg-white px-1 rounded text-xs break-all">{{ process.full_cmdline|default:process.name }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </details>
                        </div>
                    </div>
                {% endif %}
                <!-- Network Connections -->
                {% if initial_data.connections.list %}
                    <div class="dashboard-card">
                        <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">
                            Active Connections ({{ initial_data.connections.total }})
                        </h3>
                        <div class="table-container">
                            <table class="min-w-full connection-table">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">Service</th>
                                        <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">Remote Address</th>
                                        <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700 hidden sm:table-cell">Location</th>
                                        <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700 hidden md:table-cell">
                                            Organization
                                        </th>
                                        <th class="text-left py-2 px-2 md:px-4 text-xs md:text-sm font-medium text-gray-700">Protocol</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for conn in initial_data.connections.list %}
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-800">
                                                <div class="flex items-center">
                                                    <span class="mr-1 md:mr-2">{{ conn.icon }}</span>
                                                    <div>
                                                        {% if conn.local_port == "22" %}
                                                            SSH
                                                        {% elif conn.local_port == "80" %}
                                                            HTTP
                                                        {% elif conn.local_port == "443" %}
                                                            HTTPS
                                                        {% elif conn.local_port == "8000" %}
                                                            Django Dev
                                                        {% elif conn.local_port == "5432" %}
                                                            PostgreSQL
                                                        {% elif conn.local_port in "25,587,993,995" %}
                                                            Mail
                                                        {% elif conn.local_port == "53" %}
                                                            DNS
                                                        {% else %}
                                                            Port {{ conn.local_port }}
                                                        {% endif %}
                                                        <div class="text-xs text-gray-500">:{{ conn.local_port }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-600">
                                                <div class="font-mono">{{ conn.ip }}:{{ conn.port }}</div>
                                            </td>
                                            <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-600 hidden sm:table-cell">
                                                <div class="flex items-center whois-info">
                                                    <span class="mr-1 flag-emoji">{{ conn.flag }}</span>
                                                    <div>
                                                        {% if conn.whois_available %}
                                                            <div class="font-medium">{{ conn.country }}</div>
                                                            {% if conn.city != "Unknown" %}
                                                                <div class="text-xs text-gray-500">
                                                                    {{ conn.city }}
                                                                    {% if conn.region %}, {{ conn.region }}{% endif %}
                                                                </div>
                                                            {% endif %}
                                                        {% else %}
                                                            <div class="text-gray-400 italic">Unknown</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-600 hidden md:table-cell">
                                                {% if conn.whois_available %}
                                                    <div class="whois-org">
                                                        <div class="font-medium truncate" title="{{ conn.organization }}">{{ conn.organization|truncatechars:20 }}</div>
                                                        {% if conn.asn %}
                                                            <div class="text-xs text-gray-500" title="{{ conn.asn_description }}">AS{{ conn.asn }}</div>
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    <div class="text-gray-400 italic">Unknown</div>
                                                {% endif %}
                                            </td>
                                            <td class="py-2 px-2 md:px-4 text-xs md:text-sm text-gray-600">
                                                <span class="inline-flex items-center px-1.5 md:px-2.5 py-0.5 rounded-full protocol-badge {% if conn.protocol == 'TCP' %}bg-blue-100 text-blue-800 {% elif conn.protocol == 'UDP' %}bg-green-100 text-green-800 {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                    {{ conn.protocol }}
                                                </span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if initial_data.connections.total > 20 %}
                            <div class="mt-4 text-sm text-gray-500 text-center">
                                Showing 20 of {{ initial_data.connections.total }} total connections
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            <!-- Memory Analysis Link -->
            <div class="dashboard-card mb-4 md:mb-8">
                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
                    <div>
                        <h3 class="text-lg md:text-xl font-bold text-gray-800">Memory Analysis</h3>
                        <p class="text-gray-600 mt-1 text-sm md:text-base">Detailed memory usage, Python objects, and optimization insights</p>
                    </div>
                    <div class="flex items-center">
                        <a href="{% url 'memory_dashboard' %}"
                           class="inline-flex items-center px-3 md:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm md:text-base">
                            <svg class="w-4 h-4 md:w-5 md:h-5 mr-2"
                                 fill="none"
                                 stroke="currentColor"
                                 viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                </path>
                            </svg>
                            <span class="hidden sm:inline">View Memory Dashboard</span>
                            <span class="sm:hidden">Memory</span>
                        </a>
                    </div>
                </div>
                <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3 md:gap-4">
                    <div class="bg-gray-50 rounded-lg p-3 md:p-4">
                        <div class="text-xs md:text-sm font-medium text-gray-800">Python Modules</div>
                        <div class="text-xl md:text-2xl font-bold text-gray-600">{{ initial_data.modules.total_modules }}</div>
                        <div class="text-xs text-gray-500">Currently loaded</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 md:p-4">
                        <div class="text-xs md:text-sm font-medium text-gray-800">Active Sessions</div>
                        <div class="text-xl md:text-2xl font-bold text-gray-600">{{ initial_data.sessions.active_count }}</div>
                        <div class="text-xs text-gray-500">Current users</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 md:p-4">
                        <div class="text-xs md:text-sm font-medium text-gray-800">System Memory</div>
                        <div class="text-xl md:text-2xl font-bold text-gray-600">{{ initial_data.system.memory.percent|floatformat:1 }}%</div>
                        <div class="text-xs text-gray-500">Memory usage</div>
                    </div>
                </div>
            </div>
            <!-- Management Commands Card -->
            <div class="dashboard-card mb-4 md:mb-8">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
                    <h3 class="text-lg md:text-xl font-bold text-gray-800">Management Commands</h3>
                    <button onclick="loadManagementCommands()" class="refresh-btn">üîÑ Refresh</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 md:gap-4"
                     id="commands-container">
                    <div class="text-center text-gray-500 py-8 col-span-full">
                        <p class="text-sm md:text-base">Click Refresh to load available commands</p>
                    </div>
                </div>
                <!-- Command Output Console -->
                <div id="command-console" class="mt-6 hidden">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-2 gap-2">
                        <h4 class="text-base md:text-lg font-semibold text-gray-700">Command Output</h4>
                        <button onclick="clearConsole()"
                                class="text-xs md:text-sm text-gray-500 hover:text-gray-700 self-start sm:self-auto">
                            Clear
                        </button>
                    </div>
                    <div id="console-output"
                         class="bg-gray-900 text-green-400 p-3 md:p-4 rounded-lg font-mono text-xs md:text-sm h-48 md:h-64 overflow-y-auto whitespace-pre-wrap">
                    </div>
                </div>
            </div>
            <!-- Deployment Control Section -->
            <div class="dashboard-card mb-4 md:mb-8">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
                    <h3 class="text-lg md:text-xl font-bold text-gray-800">Deployment Control</h3>
                    <div class="flex items-center">
                        <button onclick="refreshDeploymentStatus()" class="refresh-btn">üîÑ Refresh Status</button>
                    </div>
                </div>
                <!-- Deployment Status Display -->
                <div id="deployment-status" class="mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 md:gap-4 mb-4">
                        <div class="bg-gray-50 rounded-lg p-3 md:p-4 border border-gray-200">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs md:text-sm font-medium text-gray-800">Service Status</span>
                                <span id="service-status-indicator"
                                      class="inline-flex items-center px-2 md:px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    Checking...
                                </span>
                            </div>
                            <div class="text-xs text-gray-600" id="service-status-details">Checking uvicorn service status...</div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-3 md:p-4 border border-blue-200">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs md:text-sm font-medium text-blue-800">Deployment Source</span>
                                <span class="text-sm md:text-lg font-bold text-blue-600">GitHub</span>
                            </div>
                            <div class="text-xs text-blue-600">Manual deployment uses current local state</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-3 md:p-4 border border-green-200">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs md:text-sm font-medium text-green-800">Last Deployment</span>
                                <span class="text-sm md:text-lg font-bold text-green-600"
                                      id="last-deployment-time">Check logs</span>
                            </div>
                            <div class="text-xs text-green-600">View logs for detailed information</div>
                        </div>
                    </div>
                </div>
                <!-- Deployment Actions -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="w-5 h-5 text-yellow-400 mt-0.5"
                                 fill="currentColor"
                                 viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd">
                                </path>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-medium text-yellow-800">Deployment Notice</h4>
                            <div class="mt-1 text-sm text-yellow-700">
                                Manual deployment will trigger the same process as GitHub webhooks:
                                <ul class="list-disc list-inside mt-1 text-xs">
                                    <li>Pull latest changes from main branch</li>
                                    <li>Install dependencies with Poetry</li>
                                    <li>Run database migrations</li>
                                    <li>Collect static files</li>
                                    <li>Restart uvicorn service</li>
                                    <li>Verify service health and website accessibility</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Deployment Button -->
                <div class="flex justify-center">
                    <button onclick="triggerDeployment()"
                            id="deploy-button"
                            class="inline-flex items-center px-4 md:px-6 py-2 md:py-3 bg-red-600 text-white text-sm md:text-lg font-semibold rounded-lg hover:bg-red-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <svg class="w-4 h-4 md:w-5 md:h-5 mr-2"
                             fill="none"
                             stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                        <span id="deploy-button-text">Deploy Now</span>
                    </button>
                </div>
                <!-- Deployment Progress Display -->
                <div id="deployment-progress" class="mt-6 hidden">
                    <div class="bg-gray-100 rounded-lg p-3 md:p-4">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-2 gap-2">
                            <h4 class="text-base md:text-lg font-semibold text-gray-700">Deployment Progress</h4>
                            <span id="deployment-progress-status"
                                  class="text-xs md:text-sm text-blue-600 font-medium">Starting...</span>
                        </div>
                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                            <div id="progress-bar"
                                 class="bg-blue-600 h-2 rounded-full transition-all duration-500"
                                 data-width="0"></div>
                        </div>
                        <!-- Step Progress -->
                        <div class="space-y-2" id="deployment-steps">
                            <div class="flex items-center text-xs md:text-sm" id="step-pull">
                                <span class="w-4 h-4 mr-2 text-gray-400">‚è≥</span>
                                <span>Pulling latest changes from Git</span>
                            </div>
                            <div class="flex items-center text-xs md:text-sm" id="step-deps">
                                <span class="w-4 h-4 mr-2 text-gray-400">‚è≥</span>
                                <span>Installing dependencies with Poetry</span>
                            </div>
                            <div class="flex items-center text-xs md:text-sm" id="step-migrate">
                                <span class="w-4 h-4 mr-2 text-gray-400">‚è≥</span>
                                <span>Running database migrations</span>
                            </div>
                            <div class="flex items-center text-xs md:text-sm" id="step-static">
                                <span class="w-4 h-4 mr-2 text-gray-400">‚è≥</span>
                                <span>Collecting static files</span>
                            </div>
                            <div class="flex items-center text-xs md:text-sm" id="step-restart">
                                <span class="w-4 h-4 mr-2 text-gray-400">‚è≥</span>
                                <span>Restarting application server</span>
                            </div>
                            <div class="flex items-center text-xs md:text-sm" id="step-health">
                                <span class="w-4 h-4 mr-2 text-gray-400">‚è≥</span>
                                <span>Verifying service health</span>
                            </div>
                            <div class="flex items-center text-xs md:text-sm" id="step-access">
                                <span class="w-4 h-4 mr-2 text-gray-400">‚è≥</span>
                                <span>Checking website accessibility</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Real-time Deployment Logs -->
                <div id="deployment-logs" class="mt-6 hidden">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-2 gap-2">
                        <h4 class="text-base md:text-lg font-semibold text-gray-700">Deployment Logs</h4>
                        <button onclick="clearDeploymentLogs()"
                                class="text-xs md:text-sm text-gray-500 hover:text-gray-700 self-start sm:self-auto">
                            Clear
                        </button>
                    </div>
                    <div id="deployment-log-container"
                         class="bg-gray-900 text-green-400 p-3 md:p-4 rounded-lg font-mono text-xs md:text-sm h-48 md:h-64 overflow-y-auto whitespace-pre-wrap">
                    </div>
                </div>
            </div>
            <!-- Environment Variables Panel -->
            <!-- Encrypted Variables Status -->
            <div class="dashboard-card mt-4 md:mt-8">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
                    <h3 class="text-lg md:text-xl font-bold text-gray-800">Encrypted Variables Status</h3>
                    <div class="flex items-center gap-2">
                        <span class="text-xs md:text-sm text-gray-500">Secure key management</span>
                        <a href="/admin/website/encryptedvariable/"
                           class="text-purple-600 hover:text-purple-800 text-xs font-medium">Manage ‚Üí</a>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 md:gap-4">
                    {% for var in encrypted_vars_status %}
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium text-gray-800">{{ var.name }}</span>
                                    {% if var.status == 'valid' %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            ‚úÖ Valid
                                        </span>
                                    {% elif var.status == 'invalid' %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            ‚ùå Invalid
                                        </span>
                                    {% elif var.status == 'missing' %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                            ‚ö†Ô∏è Missing
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            ‚ùì Error
                                        </span>
                                    {% endif %}
                                </div>
                                <span class="text-xs text-gray-500">{{ var.key_preview }}</span>
                            </div>
                            <div class="text-xs text-gray-600 mb-2">
                                <strong>Source:</strong>
                                {% if var.source == 'encrypted_variables' %}
                                    <span class="text-green-600">Encrypted Variables Table ‚úì</span>
                                {% elif var.source == 'environment_fallback' %}
                                    <span class="text-yellow-600">Environment (Fallback) ‚ö†Ô∏è</span>
                                {% elif var.source == 'missing' %}
                                    <span class="text-red-600">Not Configured ‚ùå</span>
                                {% else %}
                                    <span class="text-gray-600">{{ var.source }}</span>
                                {% endif %}
                            </div>
                            <div class="text-xs text-gray-600 mb-2">
                                <strong>Status:</strong> {{ var.message }}
                            </div>
                            {% if var.created_at %}
                                <div class="text-xs text-gray-500 border-t pt-2 mt-2">
                                    <div>
                                        <strong>Created:</strong> {{ var.created_at|date:"M d, Y H:i" }} by {{ var.created_by }}
                                    </div>
                                    {% if var.updated_at %}
                                        <div>
                                            <strong>Updated:</strong> {{ var.updated_at|date:"M d, Y H:i" }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    {% empty %}
                        <div class="col-span-full text-center text-gray-500 py-8">
                            <p class="text-sm md:text-base">No encrypted variables configured</p>
                            <a href="/admin/website/encryptedvariable/add/"
                               class="text-purple-600 hover:text-purple-800 text-sm font-medium mt-2 inline-block">
                                Add OpenAI API Key ‚Üí
                            </a>
                        </div>
                    {% endfor %}
                </div>
                {% if encrypted_vars_status %}
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-start gap-2">
                            <div class="text-blue-500 mt-0.5">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd">
                                    </path>
                                </svg>
                            </div>
                            <div class="text-xs text-blue-700">
                                <strong>Recommended:</strong> Store sensitive API keys in the encrypted variables table instead of environment variables for better security and management.
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
            <div class="dashboard-card mt-4 md:mt-8">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
                    <h3 class="text-lg md:text-xl font-bold text-gray-800">Environment Variables</h3>
                    <span class="text-xs md:text-sm text-gray-500">{{ env_vars|length }} variables loaded</span>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-3 md:gap-4">
                    {% for var in env_vars %}
                        <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                            <div class="flex items-center justify-between mb-2">
                                <span class="inline-flex items-center px-2 md:px-2.5 py-0.5 rounded-full text-xs font-medium {% if var.is_sensitive %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                                    {{ var.name }}
                                    {% if var.is_sensitive %}
                                        <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd">
                                            </path>
                                        </svg>
                                    {% endif %}
                                </span>
                                <span class="text-xs text-gray-500">{{ var.length }} chars</span>
                            </div>
                            <div class="text-xs text-gray-600 font-mono bg-white p-2 rounded border truncate">{{ var.value }}</div>
                        </div>
                    {% empty %}
                        <div class="col-span-full text-center text-gray-500 py-8">
                            <p class="text-sm md:text-base">No environment variables found</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            function refreshDashboard() {
                // Reload the page to get fresh data
                window.location.reload();
            }

            // Reload environment variables
            function reloadEnvironmentVariables() {
                const reloadBtn = document.getElementById('reload-env-btn');
                if (reloadBtn) {
                    const originalText = reloadBtn.textContent;
                    reloadBtn.textContent = 'üîÑ Reloading...';
                    reloadBtn.disabled = true;

                    fetch("{% url 'reload_env' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('‚úÖ Environment variables reloaded successfully!');
                            // Reload the page to show any updated variables
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            alert('‚ùå Failed to reload environment variables: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('‚ùå Error reloading environment variables: ' + error.message);
                    })
                    .finally(() => {
                        reloadBtn.textContent = originalText;
                        reloadBtn.disabled = false;
                    });
                }
            }

            // Management Commands Functions
            function loadManagementCommands() {
                const container = document.getElementById('commands-container');
                container.innerHTML = '<div class="text-center text-gray-500 py-4 col-span-full"><p>Loading commands...</p></div>';
                
                fetch('/admin-lkj234234ljk8c8/management-commands/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.commands && data.commands.length > 0) {
                            container.innerHTML = '';
                            data.commands.forEach(command => {
                                const commandCard = document.createElement('div');
                                commandCard.className = 'bg-gray-50 rounded-lg p-4 border border-gray-200';
                                commandCard.innerHTML = `
                                    <div class="flex justify-between items-start mb-2">
                                        <h5 class="font-semibold text-gray-800">${command.name}</h5>
                                        <button onclick="runCommand('${command.name}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">
                                            Run
                                        </button>
                                    </div>
                                    <p class="text-sm text-gray-600">${command.description}</p>
                                `;
                                container.appendChild(commandCard);
                            });
                        } else {
                            container.innerHTML = '<div class="text-center text-gray-500 py-8 col-span-full"><p>No commands available</p></div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading commands:', error);
                        container.innerHTML = '<div class="text-center text-red-500 py-8 col-span-full"><p>Error loading commands</p></div>';
                    });
            }

            function runCommand(commandName) {
                const commandConsole = document.getElementById('command-console');
                const output = document.getElementById('console-output');
                
                // Show console
                if (commandConsole) {
                    commandConsole.classList.remove('hidden');
                }
                
                // Clear previous output
                if (output) {
                    output.textContent = '';
                    output.scrollTop = output.scrollHeight;
                    
                    // Add command header
                    output.textContent += `\\n=== Running: ${commandName} ===\\n`;
                }
                
                // Make request to execute command
                fetch('/admin-lkj234234ljk8c8/execute-command/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify({
                        command: commandName,
                        args: []
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || 'Failed to execute command');
                        });
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    function readStream() {
                        return reader.read().then(({ done, value }) => {
                            if (done) {
                                output.textContent += '\\n=== Command finished ===\\n';
                                output.scrollTop = output.scrollHeight;
                                return;
                            }
                            
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\\n');
                            
                            lines.forEach(line => {
                                if (line.startsWith('data: ')) {
                                    const content = line.substring(6);
                                    if (content === '[DONE]') {
                                        output.textContent += '\\n=== Command finished ===\\n';
                                    } else {
                                        output.textContent += content + '\\n';
                                    }
                                    output.scrollTop = output.scrollHeight;
                                }
                            });
                            
                            return readStream();
                        });
                    }
                    
                    return readStream();
                })
                .catch(error => {
                    console.error('Error executing command:', error);
                    output.textContent += `\\nError: ${error.message}\\n`;
                    output.scrollTop = output.scrollHeight;
                });
            }

            function clearConsole() {
                const output = document.getElementById('console-output');
                output.textContent = '';
            }

            // Make functions available globally
            window.refreshDashboard = refreshDashboard;
            window.reloadEnvironmentVariables = reloadEnvironmentVariables;
            window.loadManagementCommands = loadManagementCommands;
            window.runCommand = runCommand;
            window.clearConsole = clearConsole;

            // System Charts Functions
            let systemCharts = {};
            
            // Ensure Chart.js is available
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
            }
            
            function initializeSystemCharts(chartData) {
                console.log('initializeSystemCharts called with:', chartData);
                
                try {
                    // Parse JSON data with error handling
                    let timestamps, cpuData, memoryData, diskData;
                    
                    try {
                        timestamps = JSON.parse(chartData.timestamps);
                        cpuData = JSON.parse(chartData.cpu_percent);
                        memoryData = JSON.parse(chartData.memory_percent);
                        diskData = JSON.parse(chartData.disk_percent);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        console.error('Raw data:', {
                            timestamps: chartData.timestamps,
                            cpu_percent: chartData.cpu_percent,
                            memory_percent: chartData.memory_percent,
                            disk_percent: chartData.disk_percent
                        });
                        return;
                    }
                    
                    console.log('Parsed data:', {
                        timestamps: timestamps,
                        cpuData: cpuData,
                        memoryData: memoryData,
                        diskData: diskData
                    });
                
                    // Mini CPU Chart
                    const miniCpuCtx = document.getElementById('miniCpuChart');
                    console.log('Mini CPU canvas element:', miniCpuCtx);
                    if (miniCpuCtx) {
                        console.log('Creating mini CPU chart...');
                        systemCharts.miniCpu = new Chart(miniCpuCtx, {
                            type: 'line',
                            data: {
                                labels: timestamps,
                                datasets: [{
                                    label: 'CPU %',
                                    data: cpuData,
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    tension: 0.1,
                                    fill: true,
                                    pointRadius: 2,
                                    pointHoverRadius: 4
                                }]
                            },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    display: false,
                                    beginAtZero: true,
                                    max: 100
                                },
                                x: {
                                    display: false
                                }
                            },
                            elements: {
                                line: {
                                    borderWidth: 2
                                }
                            }
                        }
                    });
                }

                // Mini Memory Chart
                const miniMemoryCtx = document.getElementById('miniMemoryChart');
                console.log('Mini Memory canvas element:', miniMemoryCtx);
                if (miniMemoryCtx) {
                    console.log('Creating mini Memory chart...');
                    systemCharts.miniMemory = new Chart(miniMemoryCtx, {
                        type: 'line',
                        data: {
                            labels: timestamps,
                            datasets: [{
                                label: 'Memory %',
                                data: memoryData,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.1,
                                fill: true,
                                pointRadius: 2,
                                pointHoverRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    display: false,
                                    beginAtZero: true,
                                    max: 100
                                },
                                x: {
                                    display: false
                                }
                            },
                            elements: {
                                line: {
                                    borderWidth: 2
                                }
                            }
                        }
                    });
                }

                // Mini Disk Chart
                const miniDiskCtx = document.getElementById('miniDiskChart');
                console.log('Mini Disk canvas element:', miniDiskCtx);
                if (miniDiskCtx) {
                    console.log('Creating mini Disk chart...');
                    systemCharts.miniDisk = new Chart(miniDiskCtx, {
                        type: 'line',
                        data: {
                            labels: timestamps,
                            datasets: [{
                                label: 'Disk %',
                                data: diskData,
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                tension: 0.1,
                                fill: true,
                                pointRadius: 2,
                                pointHoverRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    display: false,
                                    beginAtZero: true,
                                    max: 100
                                },
                                x: {
                                    display: false
                                }
                            },
                            elements: {
                                line: {
                                    borderWidth: 2
                                }
                            }
                        }
                    });
                }

                // Sessions Chart
                const sessionsCtx = document.getElementById('sessionsChart');
                console.log('Sessions canvas element:', sessionsCtx);
                if (sessionsCtx) {
                    console.log('Creating sessions chart...');
                    systemCharts.sessions = new Chart(sessionsCtx, {
                        type: 'bar',
                        data: {
                            labels: timestamps,
                            datasets: [{
                                label: 'Active Sessions',
                                data: JSON.parse(chartData.active_sessions),
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.6)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                },
                                x: {
                                    ticks: {
                                        maxTicksLimit: 8
                                    }
                                }
                            }
                        }
                    });
                }

                // Database Growth Chart
                const databaseCtx = document.getElementById('databaseChart');
                console.log('Database canvas element:', databaseCtx);
                if (databaseCtx) {
                    console.log('Creating database chart...');
                    systemCharts.database = new Chart(databaseCtx, {
                        type: 'bar',
                        data: {
                            labels: timestamps,
                            datasets: [{
                                label: 'Users',
                                data: JSON.parse(chartData.user_count),
                                borderColor: '#6366f1',
                                backgroundColor: 'rgba(99, 102, 241, 0.6)',
                                borderWidth: 1
                            }, {
                                label: 'Brands',
                                data: JSON.parse(chartData.brand_count),
                                borderColor: '#ec4899',
                                backgroundColor: 'rgba(236, 72, 153, 0.6)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                },
                                x: {
                                    ticks: {
                                        maxTicksLimit: 8
                                    }
                                }
                            }
                        }
                    });
                }
                
                console.log('All charts initialized successfully');
                
                } catch (error) {
                    console.error('Error initializing charts:', error);
                }
            }

            function refreshSystemStats() {
                // Get current timespan
                const timeSpanSelector = document.getElementById('timeSpanSelector');
                const timespan = timeSpanSelector ? timeSpanSelector.value : '24h';
                
                // Fetch new data via AJAX
                updateChartsWithTimespan(timespan);
            }
            
            function updateChartsWithTimespan(timespan) {
                const loadingStates = ['sessionsChart', 'databaseChart'];
                
                // Show loading state
                loadingStates.forEach(chartId => {
                    const canvas = document.getElementById(chartId);
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#f3f4f6';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#6b7280';
                        ctx.font = '16px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText('Loading...', canvas.width / 2, canvas.height / 2);
                    }
                });
                
                // Get chart data URL
                const currentUrl = new URL(window.location.href);
                const baseUrl = currentUrl.origin + currentUrl.pathname.replace('/dashboard/', '/dashboard/chart-data/');
                
                fetch(`${baseUrl}?timespan=${timespan}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(text => {
                        console.log('Raw response:', text);
                        try {
                            return JSON.parse(text);
                        } catch (parseError) {
                            console.error('JSON parse error:', parseError);
                            console.error('Response text:', text);
                            throw parseError;
                        }
                    })
                    .then(data => {
                        if (data.error) {
                            console.error('Error fetching chart data:', data.error);
                            return;
                        }
                        
                        // Update chart titles
                        const timespanLabel = data.timespan_label || '24 Hours';
                        const sessionsTitle = document.getElementById('sessionsChartTitle');
                        const databaseTitle = document.getElementById('databaseChartTitle');
                        
                        if (sessionsTitle) {
                            sessionsTitle.textContent = `Active Sessions (${timespanLabel})`;
                        }
                        if (databaseTitle) {
                            databaseTitle.textContent = `Database Growth (${timespanLabel})`;
                        }
                        
                        // Destroy existing charts
                        try {
                            Object.keys(systemCharts).forEach(key => {
                                if (systemCharts[key] && typeof systemCharts[key].destroy === 'function') {
                                    systemCharts[key].destroy();
                                    systemCharts[key] = null;
                                }
                            });
                        } catch (destroyError) {
                            console.error('Error destroying charts:', destroyError);
                        }
                        
                        // Reinitialize charts with new data
                        try {
                            const newChartData = {
                                timestamps: data.timestamps,
                                memory_percent: data.memory_percent,
                                cpu_percent: data.cpu_percent,
                                disk_percent: data.disk_percent,
                                active_sessions: data.active_sessions,
                                user_count: data.user_count,
                                brand_count: data.brand_count
                            };
                            
                            initializeSystemCharts(newChartData);
                        } catch (initError) {
                            console.error('Error initializing charts:', initError);
                        }
                    })
                    .catch(error => {
                        console.error('Error updating charts:', error);
                    });
            }

            // Auto-refresh functionality removed per user request

            // Make chart functions available globally
            window.initializeSystemCharts = initializeSystemCharts;
            window.refreshSystemStats = refreshSystemStats;
            
            // Set up time span selector
            document.addEventListener('DOMContentLoaded', function() {
                try {
                    const timeSpanSelector = document.getElementById('timeSpanSelector');
                    const refreshChartsBtn = document.getElementById('refreshChartsBtn');
                    
                    if (timeSpanSelector) {
                        timeSpanSelector.addEventListener('change', function() {
                            updateChartsWithTimespan(this.value);
                        });
                    } else {
                        console.warn('timeSpanSelector element not found');
                    }
                    
                    if (refreshChartsBtn) {
                        refreshChartsBtn.addEventListener('click', function() {
                            refreshSystemStats();
                        });
                    } else {
                        console.warn('refreshChartsBtn element not found');
                    }
                } catch (error) {
                    console.error('Error setting up time span selector:', error);
                }
            });

            // Deployment Functions
            let deploymentInProgress = false;
            let deploymentStatusInterval = null;

            function refreshDeploymentStatus() {
                fetch("{% url 'deployment_status' %}")
                    .then(response => response.json())
                    .then(data => {
                        updateServiceStatus(data);
                    })
                    .catch(error => {
                        console.error('Error refreshing deployment status:', error);
                        updateServiceStatus({
                            service_status: 'error',
                            service_active: false,
                            error: error.message
                        });
                    });
            }

            function updateServiceStatus(data) {
                const indicator = document.getElementById('service-status-indicator');
                const details = document.getElementById('service-status-details');
                
                if (indicator && details) {
                    if (data.service_active) {
                        indicator.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                        indicator.textContent = '‚úÖ Active';
                        details.textContent = `Uvicorn service is running (${data.service_status})`;
                    } else {
                        indicator.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                        indicator.textContent = '‚ùå Inactive';
                        details.textContent = data.error || `Service not active (${data.service_status})`;
                    }
                }
            }

            function triggerDeployment() {
                if (deploymentInProgress) {
                    alert('Deployment is already in progress');
                    return;
                }

                if (!confirm('Are you sure you want to start a deployment? This will restart the application server.')) {
                    return;
                }

                deploymentInProgress = true;
                
                // Update UI
                const deployButton = document.getElementById('deploy-button');
                const deployButtonText = document.getElementById('deploy-button-text');
                const progressSection = document.getElementById('deployment-progress');
                const logsSection = document.getElementById('deployment-logs');
                
                if (deployButton) {
                    deployButton.disabled = true;
                    deployButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                    deployButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                }
                if (deployButtonText) {
                    deployButtonText.textContent = 'Deployment in Progress...';
                }
                if (progressSection) {
                    progressSection.classList.remove('hidden');
                }
                if (logsSection) {
                    logsSection.classList.remove('hidden');
                }

                // Reset progress
                resetDeploymentProgress();

                // Start deployment
                fetch("{% url 'manual_deploy' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addDeploymentLog(`üöÄ Deployment started by ${data.triggered_by}`);
                        addDeploymentLog(`üìç Branch: ${data.branch}, Commit: ${data.commit}`);
                        addDeploymentLog(`‚è∞ Started at: ${new Date(data.timestamp).toLocaleString()}`);
                        
                        // Start simulated progress (since we can't get real-time feedback from the deployment process)
                        simulateDeploymentProgress();
                        
                    } else {
                        addDeploymentLog(`‚ùå Failed to start deployment: ${data.error}`);
                        if (data.details) {
                            addDeploymentLog(`Details: ${data.details}`);
                        }
                        resetDeploymentUI();
                    }
                })
                .catch(error => {
                    console.error('Error starting deployment:', error);
                    addDeploymentLog(`‚ùå Error starting deployment: ${error.message}`);
                    resetDeploymentUI();
                });
            }

            function resetDeploymentProgress() {
                const progressBar = document.getElementById('progress-bar');
                const statusSpan = document.getElementById('deployment-progress-status');
                
                if (progressBar) {
                    progressBar.style.width = '0%';
                }
                if (statusSpan) {
                    statusSpan.textContent = 'Starting...';
                }

                // Reset all step indicators
                const steps = ['pull', 'deps', 'migrate', 'static', 'restart', 'health', 'access'];
                steps.forEach(step => {
                    const stepElement = document.getElementById(`step-${step}`);
                    if (stepElement) {
                        const icon = stepElement.querySelector('span');
                        if (icon) {
                            icon.textContent = '‚è≥';
                            icon.className = 'w-4 h-4 mr-2 text-gray-400';
                        }
                    }
                });
            }

            function simulateDeploymentProgress() {
                const steps = [
                    { id: 'pull', name: 'Pulling latest changes from Git', duration: 10000 },
                    { id: 'deps', name: 'Installing dependencies with Poetry', duration: 30000 },
                    { id: 'migrate', name: 'Running database migrations', duration: 15000 },
                    { id: 'static', name: 'Collecting static files', duration: 10000 },
                    { id: 'restart', name: 'Restarting application server', duration: 20000 },
                    { id: 'health', name: 'Verifying service health', duration: 15000 },
                    { id: 'access', name: 'Checking website accessibility', duration: 10000 }
                ];

                let currentStep = 0;
                let totalDuration = steps.reduce((sum, step) => sum + step.duration, 0);
                let elapsedTime = 0;

                function updateStep() {
                    if (currentStep < steps.length) {
                        const step = steps[currentStep];
                        const progressBar = document.getElementById('progress-bar');
                        const statusSpan = document.getElementById('deployment-progress-status');
                        const stepElement = document.getElementById(`step-${step.id}`);
                        
                        // Update status
                        if (statusSpan) {
                            statusSpan.textContent = `Step ${currentStep + 1}/${steps.length}: ${step.name}`;
                        }
                        
                        // Update step indicator to "in progress"
                        if (stepElement) {
                            const icon = stepElement.querySelector('span');
                            if (icon) {
                                icon.textContent = 'üîÑ';
                                icon.className = 'w-4 h-4 mr-2 text-blue-500';
                            }
                        }
                        
                        addDeploymentLog(`üîÑ ${step.name}...`);
                        
                        setTimeout(() => {
                            // Mark step as complete
                            if (stepElement) {
                                const icon = stepElement.querySelector('span');
                                if (icon) {
                                    icon.textContent = '‚úÖ';
                                    icon.className = 'w-4 h-4 mr-2 text-green-500';
                                }
                            }
                            
                            addDeploymentLog(`‚úÖ ${step.name} completed`);
                            
                            elapsedTime += step.duration;
                            currentStep++;
                            
                            // Update progress bar
                            if (progressBar) {
                                const progress = (elapsedTime / totalDuration) * 100;
                                progressBar.style.width = `${progress}%`;
                            }
                            
                            if (currentStep < steps.length) {
                                updateStep();
                            } else {
                                // Deployment complete
                                setTimeout(() => {
                                    addDeploymentLog('üéâ Deployment completed successfully!');
                                    if (statusSpan) {
                                        statusSpan.textContent = 'Deployment completed successfully';
                                        statusSpan.className = 'text-sm text-green-600 font-medium';
                                    }
                                    if (progressBar) {
                                        progressBar.style.width = '100%';
                                        progressBar.className = 'bg-green-600 h-2 rounded-full transition-all duration-500';
                                    }
                                    
                                    // Reset UI after a delay
                                    setTimeout(() => {
                                        resetDeploymentUI();
                                        refreshDeploymentStatus(); // Refresh service status
                                    }, 5000);
                                }, 2000);
                            }
                        }, step.duration);
                    }
                }
                
                updateStep();
            }

            function resetDeploymentUI() {
                deploymentInProgress = false;
                
                const deployButton = document.getElementById('deploy-button');
                const deployButtonText = document.getElementById('deploy-button-text');
                
                if (deployButton) {
                    deployButton.disabled = false;
                    deployButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    deployButton.classList.add('bg-red-600', 'hover:bg-red-700');
                }
                if (deployButtonText) {
                    deployButtonText.textContent = 'Deploy Now';
                }
            }

            function addDeploymentLog(message) {
                const logContainer = document.getElementById('deployment-log-container');
                if (logContainer) {
                    const timestamp = new Date().toLocaleTimeString();
                    const logEntry = `[${timestamp}] ${message}\n`;
                    logContainer.textContent += logEntry;
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            }

            function clearDeploymentLogs() {
                const logContainer = document.getElementById('deployment-log-container');
                if (logContainer) {
                    logContainer.textContent = '';
                }
            }

            // Make deployment functions available globally
            window.refreshDeploymentStatus = refreshDeploymentStatus;
            window.triggerDeployment = triggerDeployment;
            window.clearDeploymentLogs = clearDeploymentLogs;

            // Initial deployment status check
            refreshDeploymentStatus();

            // WebSocket for real-time logs
            const logContainer = document.getElementById('log-container');
            if (!logContainer) {
                console.error('Log container not found');
                return;
            }

            let websocket = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            let connectionStatus = 'disconnected';
            let lastHeartbeat = Date.now();
            let heartbeatTimer = null;
            let currentLogSource = 'django';
            let reconnectTimer = null;

            function updateConnectionStatus(status, message) {
                connectionStatus = status;
                const statusText = document.getElementById('connection-status-text');
                const statusDetails = document.getElementById('connection-details');
                const statusBar = document.getElementById('connection-status-bar');
                
                if (statusText) {
                    statusText.textContent = `Status: ${status.charAt(0).toUpperCase() + status.slice(1)}`;
                }
                if (statusDetails) {
                    statusDetails.textContent = message;
                }
                if (statusBar) {
                    // Update status bar color based on status
                    statusBar.classList.remove('bg-gray-100', 'bg-green-100', 'bg-red-100', 'bg-yellow-100', 'bg-blue-100');
                    statusBar.classList.remove('text-gray-800', 'text-green-800', 'text-red-800', 'text-yellow-800', 'text-blue-800');
                    
                    switch(status) {
                        case 'connected':
                            statusBar.classList.add('bg-green-100', 'text-green-800');
                            break;
                        case 'connecting':
                        case 'reconnecting':
                            statusBar.classList.add('bg-blue-100', 'text-blue-800');
                            break;
                        case 'failed':
                        case 'error':
                        case 'closed':
                            statusBar.classList.add('bg-red-100', 'text-red-800');
                            break;
                        case 'retrying':
                        case 'stale':
                            statusBar.classList.add('bg-yellow-100', 'text-yellow-800');
                            break;
                        default:
                            statusBar.classList.add('bg-gray-100', 'text-gray-800');
                    }
                }
                console.log(`Connection status: ${status} - ${message}`);
            }

            function switchLogSource(source) {
                // Update tab appearance
                document.querySelectorAll('.log-tab').forEach(tab => {
                    tab.classList.remove('bg-blue-600', 'text-white');
                    tab.classList.add('text-gray-600', 'hover:text-gray-800');
                });
                
                const activeTab = document.getElementById(`tab-${source}`);
                if (activeTab) {
                    activeTab.classList.remove('text-gray-600', 'hover:text-gray-800');
                    activeTab.classList.add('bg-blue-600', 'text-white');
                }
                
                // Update current source
                currentLogSource = source;
                
                // If WebSocket is connected, send switch command
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({
                        type: 'switch_source',
                        source: source
                    }));
                } else {
                    // If not connected, reconnect with new source
                    reconnectAttempts = 0;
                    connectToLogStream(source);
                }
            }

            function connectToLogStream(source = 'django') {
                if (websocket) {
                    websocket.close();
                    websocket = null;
                }

                // Clear any existing timers
                if (heartbeatTimer) {
                    clearInterval(heartbeatTimer);
                    heartbeatTimer = null;
                }
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }

                updateConnectionStatus('connecting', 'Establishing WebSocket connection...');
                // Clear log container but keep the status bar
                const statusBar = document.getElementById('connection-status-bar');
                logContainer.innerHTML = '';
                if (statusBar) {
                    logContainer.appendChild(statusBar);
                }
                const connectingMsg = document.createElement('p');
                connectingMsg.textContent = 'üîÑ Connecting to log stream via WebSocket...';
                connectingMsg.style.color = '#f9fafb';
                connectingMsg.style.fontFamily = 'Consolas, "Courier New", monospace';
                logContainer.appendChild(connectingMsg);
                
                try {
                    // Determine WebSocket protocol based on current page protocol
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws/admin/logs/`;
                    console.log('Connecting to WebSocket:', wsUrl);
                    
                    // Create WebSocket connection
                    websocket = new WebSocket(wsUrl);

                    websocket.onopen = function(event) {
                        console.log('WebSocket Connection opened:', event);
                        updateConnectionStatus('connected', 'WebSocket established');
                        
                        // Clear log container but keep the status bar
                        const statusBar = document.getElementById('connection-status-bar');
                        logContainer.innerHTML = '';
                        if (statusBar) {
                            logContainer.appendChild(statusBar);
                        }
                        
                        const connectedMsg = document.createElement('p');
                        connectedMsg.textContent = '‚úÖ Connected to log stream via WebSocket - starting logs...';
                        connectedMsg.style.color = '#10b981';
                        connectedMsg.style.fontWeight = 'bold';
                        connectedMsg.style.fontFamily = 'Consolas, "Courier New", monospace';
                        logContainer.appendChild(connectedMsg);
                        
                        reconnectAttempts = 0;
                        lastHeartbeat = Date.now();
                        
                        // Start the log stream
                        websocket.send(JSON.stringify({
                            type: 'start_logs',
                            source: source
                        }));
                        
                        // Start heartbeat monitoring
                        heartbeatTimer = setInterval(() => {
                            const timeSinceHeartbeat = Date.now() - lastHeartbeat;
                            if (timeSinceHeartbeat > 60000) { // 1 minute without heartbeat
                                console.warn('No heartbeat received for 60 seconds');
                                updateConnectionStatus('stale', 'Connection may be stale');
                            }
                        }, 10000); // Check every 10 seconds
                    };
                    
                    websocket.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            console.log('WebSocket message received:', data);
                            
                            // Track heartbeat
                            if (data.type === 'heartbeat') {
                                lastHeartbeat = Date.now();
                                return;
                            }
                            
                            // Handle different message types
                            switch (data.type) {
                                case 'connection_established':
                                    console.log('WebSocket connection established');
                                    break;
                                    
                                case 'log_connection':
                                    addLogMessage(data.message, 'info');
                                    break;
                                    
                                case 'log_started':
                                    addLogMessage(data.message, 'success');
                                    break;
                                    
                                case 'log_message':
                                    addLogMessage(data.message, 'log');
                                    break;
                                    
                                case 'log_warning':
                                    addLogMessage(data.message, 'warning');
                                    break;
                                    
                                case 'log_limit':
                                    addLogMessage(data.message, 'error');
                                    break;
                                    
                                case 'logs_stopped':
                                    addLogMessage(data.message, 'info');
                                    // Don't auto-restart - let user manually restart if needed
                                    break;
                                    
                                case 'error':
                                    addLogMessage(data.message, 'error');
                                    break;
                                    
                                case 'pong':
                                    // Heartbeat response
                                    lastHeartbeat = Date.now();
                                    break;
                                    
                                default:
                                    console.log('Unknown message type:', data.type);
                            }
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                            addLogMessage('Error parsing message: ' + error.message, 'error');
                        }
                    };

                    websocket.onclose = function(event) {
                        console.log('WebSocket Connection closed:', event);
                        updateConnectionStatus('closed', `Connection closed (code: ${event.code})`);
                        
                        // Don't auto-reconnect if closed normally or due to authentication
                        if (event.code === 1000 || event.code === 4001) {
                            return;
                        }
                        
                        if (reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            const retryDelay = Math.min(2000 * Math.pow(2, reconnectAttempts - 1), 30000);
                            updateConnectionStatus('retrying', `Retry ${reconnectAttempts}/${maxReconnectAttempts} in ${retryDelay/1000}s`);
                            
                            // Clear log container but keep the status bar
                            const statusBar = document.getElementById('connection-status-bar');
                            logContainer.innerHTML = '';
                            if (statusBar) {
                                logContainer.appendChild(statusBar);
                            }
                            
                            const retryMsg = document.createElement('p');
                            retryMsg.textContent = `‚ö†Ô∏è Connection lost (code: ${event.code}). Reconnecting in ${retryDelay/1000}s... (${reconnectAttempts}/${maxReconnectAttempts})`;
                            retryMsg.style.color = '#f59e0b';
                            retryMsg.style.fontWeight = 'bold';
                            retryMsg.style.fontFamily = 'Consolas, "Courier New", monospace';
                            logContainer.appendChild(retryMsg);
                            
                            reconnectTimer = setTimeout(() => {
                                if (reconnectAttempts <= maxReconnectAttempts) {
                                    console.log('Attempting to reconnect...');
                                    connectToLogStream(currentLogSource);
                                }
                            }, retryDelay);
                        } else {
                            updateConnectionStatus('failed', 'Max retries exceeded');
                            
                            // Clear log container but keep the status bar
                            const statusBar = document.getElementById('connection-status-bar');
                            logContainer.innerHTML = '';
                            if (statusBar) {
                                logContainer.appendChild(statusBar);
                            }
                            
                            const errorDiv = document.createElement('div');
                            errorDiv.innerHTML = `
                                <p style="color: #ef4444; font-weight: bold;">‚ùå Connection failed after ${maxReconnectAttempts} attempts.</p>
                                <p style="color: #ef4444; margin: 8px 0;">Last close code: ${event.code} - ${getCloseCodeDescription(event.code)}</p>
                                <button onclick="manualReconnect()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
                                    üîÑ Manual Reconnect
                                </button>
                                <p style="font-size: 10px; color: #666; margin-top: 8px;">
                                    Check browser console for detailed error information.<br />
                                    Current URL: ${window.location.href}<br />
                                    WebSocket URL: ${wsUrl}
                                </p>
                            `;
                            logContainer.appendChild(errorDiv);
                        }
                    };
                    
                    websocket.onerror = function(error) {
                        console.error('WebSocket Error:', error);
                        updateConnectionStatus('error', 'WebSocket error');
                    };
                } catch (error) {
                    console.error('Error creating WebSocket:', error);
                    updateConnectionStatus('error', error.message);
                    
                    // Clear log container but keep the status bar
                    const statusBar = document.getElementById('connection-status-bar');
                    logContainer.innerHTML = '';
                    if (statusBar) {
                        logContainer.appendChild(statusBar);
                    }
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.innerHTML = `
                        <p style="color: #ef4444; font-weight: bold;">‚ùå Error creating WebSocket: ${error.message}</p>
                        <button onclick="connectToLogStream(currentLogSource); reconnectAttempts = 0;" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
                            üîÑ Retry Connection
                        </button>
                        <p style="font-size: 10px; color: #666; margin-top: 8px;">
                            Check browser console for detailed error information.
                        </p>
                    `;
                    logContainer.appendChild(errorDiv);
                }
            }

            function addLogMessage(message, type = 'log') {
                const newLog = document.createElement('div');
                newLog.textContent = message;
                newLog.style.margin = '1px 0';
                newLog.style.fontSize = '11px';
                newLog.style.fontFamily = 'Consolas, "Courier New", monospace';
                newLog.style.lineHeight = '1.2';
                newLog.style.wordBreak = 'break-all';
                newLog.style.whiteSpace = 'pre-wrap';
                
                // Add CSS classes for different log types
                switch (type) {
                    case 'error':
                        newLog.classList.add('log-error');
                        break;
                    case 'warning':
                        newLog.classList.add('log-warning');
                        break;
                    case 'success':
                    case 'info':
                        newLog.classList.add('log-success');
                        break;
                    case 'debug':
                        newLog.classList.add('log-debug');
                        break;
                    default:
                        // Default log color will be white via CSS
                        newLog.style.color = '#f9fafb';
                }
                
                // Always append new logs to the end (bottom) of the container
                logContainer.appendChild(newLog);
                
                // Keep only last 500 lines to prevent memory issues
                // Always preserve the status bar
                while (logContainer.children.length > 501) { // 500 logs + 1 status bar
                    const firstChild = logContainer.firstChild;
                    if (firstChild && firstChild.id !== 'connection-status-bar') {
                        logContainer.removeChild(firstChild);
                    } else if (logContainer.children.length <= 501) {
                        break;
                    }
                }
                
                // Auto-scroll to the bottom with smooth animation
                logContainer.scrollTo({
                    top: logContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }

            // Generate test log entry
            function generateTestLog() {
                const timestamp = new Date().toISOString();
                fetch("{% url 'admin_logs_debug' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        action: 'generate_test_log',
                        timestamp: timestamp
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Test log generated:', data);
                    
                    // Show a temporary message in the log container
                    const testDiv = document.createElement('div');
                    testDiv.innerHTML = `<p style="color: #10b981; font-weight: bold;">üß™ Test log entry generated at ${timestamp} - should appear in stream shortly</p>`;
                    testDiv.style.border = '1px solid #10b981';
                    testDiv.style.padding = '8px';
                    testDiv.style.margin = '5px 0';
                    testDiv.style.borderRadius = '4px';
                    testDiv.style.backgroundColor = '#f0fdf4';
                    
                    logContainer.appendChild(testDiv);
                    logContainer.scrollTo({
                        top: logContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                    
                    // Remove the test message after 10 seconds
                    setTimeout(() => {
                        if (testDiv.parentNode) {
                            testDiv.parentNode.removeChild(testDiv);
                        }
                    }, 10000);
                })
                .catch(error => {
                    console.error('Test log generation failed:', error);
                    alert('Test log generation failed. Check browser console for details.');
                });
            }

            // Debug function
            function debugLogStream() {
                fetch("{% url 'admin_logs_debug' %}")
                    .then(response => response.json())
                    .then(data => {
                        console.log('Debug info:', data);
                        alert('Debug info logged to console. Check browser console for details.');
                        
                        // Also show in log container
                        const debugDiv = document.createElement('div');
                        debugDiv.innerHTML = `
                            <h4 style="color: #3b82f6; margin: 10px 0;">Debug Information:</h4>
                            ${data.debug_info.map(info => `<p style="margin: 2px 0; color: #6b7280;">${info}</p>`).join('')}
                        `;
                        debugDiv.style.border = '1px solid #3b82f6';
                        debugDiv.style.padding = '10px';
                        debugDiv.style.margin = '10px 0';
                        debugDiv.style.borderRadius = '4px';
                        debugDiv.style.backgroundColor = '#f8fafc';
                        
                        logContainer.appendChild(debugDiv);
                        logContainer.scrollTo({
                            top: logContainer.scrollHeight,
                            behavior: 'smooth'
                        });
                    })
                    .catch(error => {
                        console.error('Debug request failed:', error);
                        alert('Debug request failed. Check browser console for details.');
                    });
            }

            // Helper function for WebSocket close codes
            function getCloseCodeDescription(code) {
                const codes = {
                    1000: 'Normal closure',
                    1001: 'Going away',
                    1002: 'Protocol error',
                    1003: 'Unsupported data',
                    1004: 'Reserved',
                    1005: 'No status received',
                    1006: 'Abnormal closure',
                    1007: 'Invalid frame payload data',
                    1008: 'Policy violation',
                    1009: 'Message too large',
                    1010: 'Missing extension',
                    1011: 'Internal error',
                    1012: 'Service restart',
                    1013: 'Try again later',
                    1014: 'Bad gateway',
                    1015: 'TLS handshake',
                    4001: 'Authentication failed'
                };
                return codes[code] || 'Unknown';
            }

            // Manual reconnect function
            function manualReconnect() {
                console.log('Manual reconnect triggered');
                reconnectAttempts = 0;
                connectToLogStream(currentLogSource);
            }

            // Restart log stream function
            function restartLogStream() {
                console.log('Manual log stream restart triggered');
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    // Stop current stream
                    websocket.send(JSON.stringify({
                        type: 'stop_logs'
                    }));
                    
                    // Start new stream after a short delay
                    setTimeout(() => {
                        if (websocket && websocket.readyState === WebSocket.OPEN) {
                            websocket.send(JSON.stringify({
                                type: 'start_logs',
                                source: currentLogSource
                            }));
                        }
                    }, 1000);
                } else {
                    // If WebSocket is not connected, try to reconnect
                    manualReconnect();
                }
            }

            // Add periodic connection health check
            let healthCheckInterval = setInterval(() => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    // Send ping to server
                    websocket.send(JSON.stringify({
                        type: 'ping',
                        timestamp: Date.now()
                    }));
                }
            }, 30000); // Check every 30 seconds

            // Make functions available globally
            window.connectToLogStream = connectToLogStream;
            window.debugLogStream = debugLogStream;
            window.generateTestLog = generateTestLog;
            window.switchLogSource = switchLogSource;
            window.manualReconnect = manualReconnect;
            window.restartLogStream = restartLogStream;
            window.getCloseCodeDescription = getCloseCodeDescription;

            // Start the connection with default source
            connectToLogStream(currentLogSource);

            // Cleanup on page unload
            window.addEventListener('beforeunload', function() {
                if (websocket) {
                    websocket.close(1000, 'Page unloading');
                }
                if (heartbeatTimer) {
                    clearInterval(heartbeatTimer);
                }
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                }
                if (healthCheckInterval) {
                    clearInterval(healthCheckInterval);
                }
            });

            // Also cleanup when tab becomes hidden
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log('Page hidden, closing WebSocket connection');
                    if (websocket) {
                        websocket.close(1000, 'Page hidden');
                    }
                } else {
                    console.log('Page visible, reconnecting WebSocket');
                    if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                        reconnectAttempts = 0;
                        connectToLogStream(currentLogSource);
                    }
                }
            });

            // Update timestamp display
            function updateTimestamp() {
                const timestampElement = document.getElementById('last-updated');
                if (timestampElement) {
                    const now = new Date();
                    timestampElement.textContent = 'Last updated: ' + now.toLocaleString();
                }
                
                // Update server time display (use UTC to match log timestamps)
                const serverTimeElement = document.getElementById('server-time');
                if (serverTimeElement) {
                    const now = new Date();
                    const year = now.getUTCFullYear();
                    const month = String(now.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(now.getUTCDate()).padStart(2, '0');
                    const hours = String(now.getUTCHours()).padStart(2, '0');
                    const minutes = String(now.getUTCMinutes()).padStart(2, '0');
                    const seconds = String(now.getUTCSeconds()).padStart(2, '0');
                    
                    serverTimeElement.textContent = `${year}-${month}-${day} ${hours}:${minutes}:${seconds} UTC`;
                }
            }

            // Update timestamp every second
            setInterval(updateTimestamp, 1000);
        });
    </script>
{% endblock content %}
