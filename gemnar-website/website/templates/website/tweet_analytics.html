{% extends "website/base.html" %}
{% load static %}
{% block title %}{{ title }} - Gemnar{% endblock %}
{% block content %}
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">{{ title }}</h1>
            <div class="flex space-x-4">
                <a href="{% url 'website:tweet_dashboard' %}"
                   class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Back to Dashboard</a>
                <a href="{% url 'website:tweet_history' %}"
                   class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">View History</a>
            </div>
        </div>
        <!-- Date Range Filter -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Date Range</h2>
                <form method="get" class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label for="start_date" class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                        <input type="date"
                               id="start_date"
                               name="start_date"
                               value="{{ date_range.start|date:'Y-m-d' }}"
                               class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="end_date" class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                        <input type="date"
                               id="end_date"
                               name="end_date"
                               value="{{ date_range.end|date:'Y-m-d' }}"
                               class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        Apply Filter
                    </button>
                </form>
            </div>
        </div>
        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Tweets</p>
                        <p class="text-3xl font-bold text-gray-800">{{ total_tweets }}</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-twitter text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Posted Successfully</p>
                        <p class="text-3xl font-bold text-green-600">{{ posted_tweets }}</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-check text-green-600 text-2xl"></i>
                    </div>
                </div>
                {% if total_tweets > 0 %}
                    <div class="mt-2">
                        <div class="text-sm text-gray-600">
                            Success Rate: {{ posted_tweets|floatformat:0 }}/{{ total_tweets }} ({% widthratio posted_tweets total_tweets 100 %}%)
                        </div>
                    </div>
                {% endif %}
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Failed Tweets</p>
                        <p class="text-3xl font-bold text-red-600">{{ failed_tweets }}</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                    </div>
                </div>
                {% if total_tweets > 0 %}
                    <div class="mt-2">
                        <div class="text-sm text-gray-600">
                            Failure Rate: {{ failed_tweets|floatformat:0 }}/{{ total_tweets }} ({% widthratio failed_tweets total_tweets 100 %}%)
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        <!-- Daily Tweet Chart -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Daily Tweet Activity</h2>
                {% if daily_counts %}
                    <div class="relative">
                        <canvas id="dailyChart" width="400" height="200"></canvas>
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-chart-bar text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-600">No data available for the selected date range</p>
                    </div>
                {% endif %}
            </div>
        </div>
        <!-- Status Distribution -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Tweet Status Distribution</h2>
                {% if status_counts %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <canvas id="statusChart" width="300" height="300"></canvas>
                        </div>
                        <div class="space-y-3">
                            {% for status in status_counts %}
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center">
                                        {% if status.status == 'posted' %}
                                            <div class="w-4 h-4 bg-green-500 rounded-full mr-3"></div>
                                            <span class="text-gray-700 capitalize">Posted</span>
                                        {% elif status.status == 'failed' %}
                                            <div class="w-4 h-4 bg-red-500 rounded-full mr-3"></div>
                                            <span class="text-gray-700 capitalize">Failed</span>
                                        {% elif status.status == 'pending' %}
                                            <div class="w-4 h-4 bg-yellow-500 rounded-full mr-3"></div>
                                            <span class="text-gray-700 capitalize">Pending</span>
                                        {% elif status.status == 'approved' %}
                                            <div class="w-4 h-4 bg-blue-500 rounded-full mr-3"></div>
                                            <span class="text-gray-700 capitalize">Approved</span>
                                        {% else %}
                                            <div class="w-4 h-4 bg-gray-500 rounded-full mr-3"></div>
                                            <span class="text-gray-700 capitalize">{{ status.status }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="text-gray-800 font-semibold">{{ status.count }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-chart-pie text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-600">No tweets found for the selected date range</p>
                    </div>
                {% endif %}
            </div>
        </div>
        <!-- Additional Analytics -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Quick Actions</h3>
                <div class="space-y-3">
                    <a href="{% url 'website:tweet_config_create' %}"
                       class="block w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded text-center">
                        Create New Configuration
                    </a>
                    <a href="{% url 'website:tweet_history' %}"
                       class="block w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-center">
                        View All Tweets
                    </a>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Date Range Summary</h3>
                <div class="space-y-2 text-sm text-gray-600">
                    <div class="flex justify-between">
                        <span>From:</span>
                        <span class="font-medium">{{ date_range.start|date:'M d, Y' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>To:</span>
                        <span class="font-medium">{{ date_range.end|date:'M d, Y' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Days:</span>
                        <span class="font-medium">{{ date_range.start|timesince:date_range.end|floatformat:0 }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // Daily Tweet Chart
    {% if daily_counts %}
    const dailyData = {{ daily_counts|safe }};
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: dailyData.map(item => new Date(item.date).toLocaleDateString()),
            datasets: [{
                label: 'Tweets per Day',
                data: dailyData.map(item => item.count),
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Daily Tweet Activity'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    {% endif %}

    // Status Distribution Chart
    {% if status_counts %}
    const statusData = {{ status_counts|safe }};
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    
    const statusColors = {
        'posted': '#10B981',
        'failed': '#EF4444',
        'pending': '#F59E0B',
        'approved': '#3B82F6',
        'default': '#6B7280'
    };
    
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: statusData.map(item => item.status.charAt(0).toUpperCase() + item.status.slice(1)),
            datasets: [{
                data: statusData.map(item => item.count),
                backgroundColor: statusData.map(item => statusColors[item.status] || statusColors['default']),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Tweet Status Distribution'
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    {% endif %}
});
    </script>
{% endblock %}
