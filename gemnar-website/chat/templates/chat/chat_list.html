{% extends 'website/base.html' %}
{% load static %}
{% block content %}
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Your Conversations</h1>
            <button id="startChatBtn"
                    class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                Start New Chat
            </button>
        </div>
        <!-- New Conversations -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4">Active Conversations</h2>
            <div class="grid gap-6">
                {% for conversation in conversations %}
                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h3 class="text-xl font-semibold">
                                    {% if conversation.brand %}
                                        {% if user == conversation.brand.owner %}
                                            Chat with {{ conversation.participant2.username }}
                                        {% else %}
                                            {{ conversation.brand.name }}
                                        {% endif %}
                                    {% else %}
                                        {% if user == conversation.participant1 %}
                                            Chat with {{ conversation.participant2.username }}
                                        {% else %}
                                            Chat with {{ conversation.participant1.username }}
                                        {% endif %}
                                    {% endif %}
                                </h3>
                                <p class="text-gray-600">
                                    {% if conversation.brand %}
                                        <span class="text-blue-600 font-medium">Brand Chat</span> •
                                    {% else %}
                                        <span class="text-green-600 font-medium">Direct Chat</span> •
                                    {% endif %}
                                    Last active: {{ conversation.updated_at|timesince }} ago
                                </p>
                            </div>
                            <a href="{% url 'chat:conversation_detail' conversation.id %}"
                               class="bg-pink-500 text-white px-6 py-2 rounded-full hover:bg-pink-600 transition-colors">
                                Open Chat
                            </a>
                        </div>
                        {% with last_message=conversation.messages.last %}
                            {% if last_message %}
                                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                                    <p class="text-gray-600">
                                        <span class="font-semibold">{{ last_message.sender.username }}:</span>
                                        {{ last_message.get_decrypted_content|truncatechars:100 }}
                                    </p>
                                </div>
                            {% endif %}
                        {% endwith %}
                    </div>
                {% endfor %}
            </div>
        </div>
        <!-- Legacy Chat Rooms (for backward compatibility) -->
        {% if legacy_rooms %}
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4">Legacy Chats</h2>
                <div class="grid gap-6">
                    {% for room in legacy_rooms %}
                        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow border-l-4 border-yellow-400">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-semibold">
                                        {% if user == room.user %}
                                            {{ room.brand.name }}
                                        {% else %}
                                            {{ room.user.username }}
                                        {% endif %}
                                    </h3>
                                    <p class="text-gray-600">
                                        <span class="text-yellow-600 font-medium">Legacy Chat</span> •
                                        Last active: {{ room.updated_at|timesince }} ago
                                    </p>
                                </div>
                                <a href="{% url 'chat:chat_room' room.id %}"
                                   class="bg-yellow-500 text-white px-6 py-2 rounded-full hover:bg-yellow-600 transition-colors">
                                    Open Chat
                                </a>
                            </div>
                            {% with last_message=room.messages.last %}
                                {% if last_message %}
                                    <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                                        <p class="text-gray-600">
                                            <span class="font-semibold">{{ last_message.sender.username }}:</span>
                                            {{ last_message.get_decrypted_content|truncatechars:100 }}
                                        </p>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
        <!-- Empty State -->
        {% if not conversations and not legacy_rooms %}
            <div class="text-center py-12">
                <div class="max-w-md mx-auto">
                    <div class="mb-6">
                        <svg class="mx-auto h-24 w-24 text-gray-400"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">No conversations yet</h3>
                    <p class="text-gray-600 mb-6">Start your first conversation by entering someone's email address.</p>
                    <button id="startFirstChatBtn"
                            class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Start Your First Chat
                    </button>
                </div>
            </div>
        {% endif %}
    </div>
    <!-- Start Chat Modal -->
    <div id="startChatModal"
         class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Start New Conversation</h2>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="startChatForm">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label for="emailInput" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                        <input type="email"
                               id="emailInput"
                               name="email"
                               required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Enter email address...">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button"
                                id="cancelBtn"
                                class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">Cancel</button>
                        <button type="submit"
                                id="submitBtn"
                                class="bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 transition-colors">
                            Start Chat
                        </button>
                    </div>
                </form>
                <!-- Loading and Error States -->
                <div id="loadingState" class="hidden text-center py-4">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <p class="mt-2 text-gray-600">Starting conversation...</p>
                </div>
                <div id="errorState"
                     class="hidden bg-red-50 border border-red-200 rounded-md p-4 mt-4">
                    <div class="flex">
                        <svg class="w-5 h-5 text-red-400 mr-2"
                             fill="currentColor"
                             viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        <div>
                            <p class="text-sm text-red-800" id="errorMessage"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const startChatBtn = document.getElementById('startChatBtn');
    const startFirstChatBtn = document.getElementById('startFirstChatBtn');
    const modal = document.getElementById('startChatModal');
    const closeModal = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const form = document.getElementById('startChatForm');
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const errorMessage = document.getElementById('errorMessage');
    
    // Open modal handlers
    function openModal() {
        modal.classList.remove('hidden');
        document.getElementById('emailInput').focus();
    }
    
    if (startChatBtn) {
        startChatBtn.addEventListener('click', openModal);
    }
    
    if (startFirstChatBtn) {
        startFirstChatBtn.addEventListener('click', openModal);
    }
    
    // Close modal handlers
    function closeModalHandler() {
        modal.classList.add('hidden');
        form.reset();
        hideStates();
    }
    
    closeModal.addEventListener('click', closeModalHandler);
    cancelBtn.addEventListener('click', closeModalHandler);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModalHandler();
        }
    });
    
    // Hide loading/error states
    function hideStates() {
        loadingState.classList.add('hidden');
        errorState.classList.add('hidden');
        form.classList.remove('hidden');
    }
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const emailInput = document.getElementById('emailInput');
        const email = emailInput.value.trim();
        
        if (!email) {
            showError('Please enter an email address');
            return;
        }
        
        // Show loading state
        form.classList.add('hidden');
        loadingState.classList.remove('hidden');
        hideStates();
        loadingState.classList.remove('hidden');
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Make API call
        fetch('{% url "chat:start_conversation_by_email" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ email: email })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect to the conversation
                window.location.href = `/chat/conversation/${data.conversation_id}/`;
            } else {
                showError(data.error || 'Failed to start conversation');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('An error occurred. Please try again.');
        });
    });
    
    function showError(message) {
        loadingState.classList.add('hidden');
        form.classList.remove('hidden');
        errorState.classList.remove('hidden');
        errorMessage.textContent = message;
    }
});
    </script>
{% endblock %}
